<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Build and Configuration Systems &mdash; Zephyr Project Documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script type="module" src="../../_static/js/dark-mode-toggle.min.mjs"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-831873-47"></script>
        <script src="../../_static/js/ga-tracker.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="Interactive Kconfig interfaces" href="kconfig/menuconfig.html" />
    <link rel="prev" title="Code Documentation" href="../../development_process/documentation.html" />
  <meta name="color-scheme" content="dark light">
  
  <link rel="stylesheet" href="../../_static/css/light.css" type="text/css" media="(prefers-color-scheme: light)"/>
  <link rel="stylesheet" href="../../_static/css/dark.css" type="text/css" media="(prefers-color-scheme: dark)"/>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.99
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Document Release Versions</dt>
        
          <dd><a href="/">latest</a></dd>
        
          <dd><a href="/3.0.0/">3.0.0</a></dd>
        
          <dd><a href="/2.7.0/">2.7.0</a></dd>
        
          <dd><a href="/2.6.0/">2.6.0</a></dd>
        
          <dd><a href="/2.5.0/">2.5.0</a></dd>
        
          <dd><a href="/2.4.0/">2.4.0</a></dd>
        
          <dd><a href="/2.3.0/">2.3.0</a></dd>
        
          <dd><a href="/1.14.1/">1.14.1</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
        <dd><a href="/latest/zephyr.pdf">PDF</a></dd>
      </dl>
      <dl>
        <dt>zephyrproject.org Links</dt>
          <dd>
            <a href="https://www.zephyrproject.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/sdk-ng/releases">SDK</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/zephyr/releases">Releases</a>
          </dd>
      </dl>
    </div>
  </div>
  
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Build and Configuration Systems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#build-system-cmake">Build System (CMake)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-and-configuration-phases">Build and Configuration Phases</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuration-phase">Configuration Phase</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-phase">Build Phase</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#supporting-scripts-and-tools">Supporting Scripts and Tools</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#scripts-gen-syscalls-py">scripts/gen_syscalls.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-gen-handles-py">scripts/gen_handles.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-gen-kobject-list-py">scripts/gen_kobject_list.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-gen-offset-header-py">scripts/gen_offset_header.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-parse-syscalls-py">scripts/parse_syscalls.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arch-x86-gen-idt-py">arch/x86/gen_idt.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arch-x86-gen-gdt-py">arch/x86/gen_gdt.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-gen-relocate-app-py">scripts/gen_relocate_app.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-process-gperf-py">scripts/process_gperf.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-gen-app-partitions-py">scripts/gen_app_partitions.py</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-system-kconfig">Configuration System (Kconfig)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="kconfig/menuconfig.html">Interactive Kconfig interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="kconfig/setting.html">Setting Kconfig configuration values</a></li>
<li class="toctree-l3"><a class="reference internal" href="kconfig/tips.html">Kconfig - Tips and Best Practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="kconfig/preprocessor-functions.html">Custom Kconfig Preprocessor Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="kconfig/extensions.html">Kconfig extensions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../application/index.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">User and Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Release Notes</a></li>
</ul>

  
  <div class="toctree-wrapper compound">
    <p class="caption"><span class="caption-text">Reference</span></p>
    <ul>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/doxygen/html/index.html">API</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/kconfig.html">Kconfig Options</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/devicetree/bindings.html">Devicetree Bindings</a>
      </li>
      
    </ul>
  </div>
  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zephyr Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <!-- Docs / Latest -->
  
  

  <li><a href="../../index.html">Docs / Latest</a> &raquo;</li>
  
  <li>Build and Configuration Systems</li>


  <li class="wy-breadcrumbs-aside">
    <dark-mode-toggle id="dark-mode-toggle" appearance="toggle" permanent="true"/>
  </li>
  <li class="wy-breadcrumbs-aside">
      
      
        <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/doc/guides/build/index.rst" class="fa fa-github"> Open on GitHub</a>
      
    
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
    <div class="wy-alert wy-alert-danger">
     This is the documentation for the latest (main) development branch of
     Zephyr. If you are looking for the documentation of previous releases, use
     the drop-down menu on the left and select the desired version.
    </div>
  
  
           <div itemprop="articleBody">
             
  <div class="section" id="build-and-configuration-systems">
<span id="build-overview"></span><h1>Build and Configuration Systems<a class="headerlink" href="#build-and-configuration-systems" title="Permalink to this headline">¶</a></h1>
<div class="section" id="build-system-cmake">
<span id="cmake-details"></span><h2>Build System (CMake)<a class="headerlink" href="#build-system-cmake" title="Permalink to this headline">¶</a></h2>
<p>CMake is used to build your application together with the Zephyr kernel. A
CMake build is done in two stages. The first stage is called
<strong>configuration</strong>. During configuration, the CMakeLists.txt build scripts are
executed. After configuration is finished, CMake has an internal model of the
Zephyr build, and can generate build scripts that are native to the host
platform.</p>
<p>CMake supports generating scripts for several build systems, but only Ninja and
Make are tested and supported by Zephyr. After configuration, you begin the
<strong>build</strong> stage by executing the generated build scripts. These build scripts
can recompile the application without involving CMake following
most code changes. However, after certain changes, the configuration step must
be executed again before building. The build scripts can detect some of these
situations and reconfigure automatically, but there are cases when this must be
done manually.</p>
<p>Zephyr uses CMake’s concept of a ‘target’ to organize the build. A
target can be an executable, a library, or a generated file. For
application developers, the library target is the most important to
understand. All source code that goes into a Zephyr build does so by
being included in a library target, even application code.</p>
<p>Library targets have source code, that is added through CMakeLists.txt
build scripts like this:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_sources</span><span class="p">(</span><span class="s">app</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">src/main.c</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above <code class="file docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, an existing library target named <code class="docutils literal notranslate"><span class="pre">app</span></code>
is configured to include the source file <code class="file docutils literal notranslate"><span class="pre">src/main.c</span></code>. The <code class="docutils literal notranslate"><span class="pre">PRIVATE</span></code>
keyword indicates that we are modifying the internals of how the library is
being built. Using the keyword <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code> would modify how other
libraries that link with app are built. In this case, using <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code>
would cause libraries that link with <code class="docutils literal notranslate"><span class="pre">app</span></code> to also include the
source file <code class="file docutils literal notranslate"><span class="pre">src/main.c</span></code>, behavior that we surely do not want. The
<code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code> keyword could however be useful when modifying the include
paths of a target library.</p>
<div class="section" id="build-and-configuration-phases">
<h3>Build and Configuration Phases<a class="headerlink" href="#build-and-configuration-phases" title="Permalink to this headline">¶</a></h3>
<p>The Zephyr build process can be divided into two main phases: a configuration
phase (driven by CMake) and a build phase (driven by Make or Ninja).</p>
<div class="section" id="configuration-phase">
<span id="build-configuration-phase"></span><h4>Configuration Phase<a class="headerlink" href="#configuration-phase" title="Permalink to this headline">¶</a></h4>
<p>The configuration phase begins when the user invokes <em>CMake</em> to generate a
build system, specifying a source application directory and a board target.</p>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-config-phase.svg"><img alt="Zephyr's build configuration phase" src="../../_images/build-config-phase.svg" width="80%" /></a>
</div>
<p>CMake begins by processing the <code class="file docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file in the application
directory, which refers to the <code class="file docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file in the Zephyr
top-level directory, which in turn refers to <code class="file docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> files
throughout the build tree (directly and indirectly). Its primary output is a
set of Makefiles or Ninja files to drive the build process, but the CMake
scripts also do some processing of their own, which is explained here.</p>
<p>Note that paths beginning with <code class="file docutils literal notranslate"><span class="pre">build/</span></code> below refer to the build
directory you create when running CMake.</p>
<dl>
<dt>Devicetree</dt><dd><p><code class="file docutils literal notranslate"><span class="pre">*.dts</span></code> (<em>devicetree source</em>) and <code class="file docutils literal notranslate"><span class="pre">*.dtsi</span></code> (<em>devicetree source
include</em>) files are collected from the target’s architecture, SoC, board,
and application directories.</p>
<p><code class="file docutils literal notranslate"><span class="pre">*.dtsi</span></code> files are included by <code class="file docutils literal notranslate"><span class="pre">*.dts</span></code> files via the C
preprocessor (often abbreviated <em>cpp</em>, which should not be confused with
C++). The C preprocessor is also used to merge in any devicetree
<code class="file docutils literal notranslate"><span class="pre">*.overlay</span></code> files, and to expand macros in <code class="file docutils literal notranslate"><span class="pre">*.dts</span></code>,
<code class="file docutils literal notranslate"><span class="pre">*.dtsi</span></code>, and <code class="file docutils literal notranslate"><span class="pre">*.overlay</span></code> files. The preprocessor output is
placed in <code class="file docutils literal notranslate"><span class="pre">build/zephyr/zephyr.dts.pre</span></code>.</p>
<p>The preprocessed devicetree sources are parsed by
<a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/dts/gen_defines.py">gen_defines.py </a> to generate a
<code class="file docutils literal notranslate"><span class="pre">build/zephyr/include/generated/devicetree_unfixed.h</span></code> header with
preprocessor macros.</p>
<p>Source code should access preprocessor macros generated from devicetree by
including the <a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/include/devicetree.h">devicetree.h </a> header,
which includes <code class="file docutils literal notranslate"><span class="pre">devicetree_unfixed.h</span></code>.</p>
<p><code class="file docutils literal notranslate"><span class="pre">gen_defines.py</span></code> also writes the final devicetree to
<code class="file docutils literal notranslate"><span class="pre">build/zephyr/zephyr.dts</span></code> in the build directory. This file’s contents
may be useful for debugging.</p>
<p>If the devicetree compiler <code class="docutils literal notranslate"><span class="pre">dtc</span></code> is installed, it is run on
<code class="file docutils literal notranslate"><span class="pre">build/zephyr/zephyr.dts</span></code> to catch any extra warnings and errors
generated by this tool. The output from <code class="docutils literal notranslate"><span class="pre">dtc</span></code> is unused otherwise, and
this step is skipped if <code class="docutils literal notranslate"><span class="pre">dtc</span></code> is not installed.</p>
<p>The above is just a brief overview. For more information on devicetree, see
<a class="reference internal" href="../dts/index.html#dt-guide"><span class="std std-ref">Devicetree Guide</span></a>.</p>
</dd>
<dt>Devicetree fixups</dt><dd><p>Files named <code class="file docutils literal notranslate"><span class="pre">dts_fixup.h</span></code> from the target’s architecture, SoC, board,
and application directories are concatenated into a single
<code class="file docutils literal notranslate"><span class="pre">devicetree_fixups.h</span></code> file. <code class="file docutils literal notranslate"><span class="pre">dts_fixup.h</span></code> files are a legacy
feature which should not be used in new code.</p>
</dd>
<dt>Kconfig</dt><dd><p><code class="file docutils literal notranslate"><span class="pre">Kconfig</span></code> files define available configuration options for for the
target architecture, SoC, board, and application, as well as dependencies
between options.</p>
<p>Kconfig configurations are stored in <em>configuration files</em>. The initial
configuration is generated by merging configuration fragments from the board
and application (e.g. <code class="file docutils literal notranslate"><span class="pre">prj.conf</span></code>).</p>
<p>The output from Kconfig is an <code class="file docutils literal notranslate"><span class="pre">autoconf.h</span></code> header with preprocessor
assignments, and a <code class="file docutils literal notranslate"><span class="pre">.config</span></code> file that acts both as a saved
configuration and as configuration output (used by CMake).</p>
<p>Information from devicetree is available to Kconfig, through the functions
defined in <a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/kconfig/kconfigfunctions.py">kconfigfunctions.py</a>.</p>
<p>See <a class="reference internal" href="#kconfig"><span class="std std-ref">the Kconfig section of the manual</span></a> for more information.</p>
</dd>
</dl>
</div>
<div class="section" id="build-phase">
<h4>Build Phase<a class="headerlink" href="#build-phase" title="Permalink to this headline">¶</a></h4>
<p>The build phase begins when the user invokes <code class="docutils literal notranslate"><span class="pre">make</span></code> or <code class="docutils literal notranslate"><span class="pre">ninja</span></code>. Its
ultimate output is a complete Zephyr application in a format suitable for
loading/flashing on the desired target board (<code class="file docutils literal notranslate"><span class="pre">zephyr.elf</span></code>,
<code class="file docutils literal notranslate"><span class="pre">zephyr.hex</span></code>, etc.) The build phase can be broken down, conceptually,
into four stages: the pre-build, first-pass binary, final binary, and
post-processing.</p>
<div class="section" id="pre-build">
<h5>Pre-build<a class="headerlink" href="#pre-build" title="Permalink to this headline">¶</a></h5>
<p>Pre-build occurs before any source files are compiled, because during
this phase header files used by the source files are generated.</p>
<dl class="simple">
<dt>Offset generation</dt><dd><p>Access to high-level data structures and members is sometimes
required when the definitions of those structures is not
immediately accessible (e.g., assembly language). The generation of
<em>offsets.h</em> (by <em>gen_offset_header.py</em>) facilitates this.</p>
</dd>
<dt>System call boilerplate</dt><dd><p>The <em>gen_syscall.py</em> and <em>parse_syscalls.py</em>  scripts work
together to bind potential system call functions with their
implementations.</p>
</dd>
</dl>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-build-phase-1.svg"><img alt="Zephyr's build stage I" src="../../_images/build-build-phase-1.svg" width="80%" /></a>
</div>
</div>
<div class="section" id="intermediate-binaries">
<h5>Intermediate binaries<a class="headerlink" href="#intermediate-binaries" title="Permalink to this headline">¶</a></h5>
<p>Compilation proper begins with the first intermediate binary. Source files (C
and assembly) are collected from various subsystems (which ones is
decided during the configuration phase), and compiled into archives
(with reference to header files in the tree, as well as those
generated during the configuration phase and the pre-build stage(s)).</p>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-build-phase-2.svg"><img alt="Zephyr's build stage II" src="../../_images/build-build-phase-2.svg" width="80%" /></a>
</div>
<p>The exact number of intermediate binaries is decided during the configuration
phase.</p>
<p>If memory protection is enabled, then:</p>
<dl class="simple">
<dt>Partition grouping</dt><dd><p>The <em>gen_app_partitions.py</em> script scans all the
generated archives and outputs linker scripts to ensure that
application partitions are properly grouped and aligned for the
target’s memory protection hardware.</p>
</dd>
</dl>
<p>Then <em>cpp</em> is used to combine linker script fragments from the target’s
architecture/SoC, the kernel tree, optionally the partition output if
memory protection is enabled, and any other fragments selected during
the configuration process, into a <em>linker.cmd</em> file. The compiled
archives are then linked with <em>ld</em> as specified in the
<em>linker.cmd</em>.</p>
<dl class="simple">
<dt>Unfixed size binary</dt><dd><p>The unfixed size intermediate binary is produced when <a class="reference internal" href="../../reference/usermode/index.html#usermode-api"><span class="std std-ref">User Mode</span></a>
is enabled or <a class="reference internal" href="../../reference/devicetree/index.html#devicetree"><span class="std std-ref">Devicetree</span></a> is in use.
It produces a binary where sizes are not fixed and thus it may be used
by post-process steps that will impact the size of the final binary.</p>
</dd>
</dl>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-build-phase-3.svg"><img alt="Zephyr's build stage III" src="../../_images/build-build-phase-3.svg" width="80%" /></a>
</div>
<dl class="simple">
<dt>Fixed size binary</dt><dd><p>The fixed size intermediate binary is produced when <a class="reference internal" href="../../reference/usermode/index.html#usermode-api"><span class="std std-ref">User Mode</span></a>
is enabled or when generated IRQ tables are used,
<a class="reference internal" href="../../kconfig.html#CONFIG_GEN_ISR_TABLES" title="CONFIG_GEN_ISR_TABLES"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_GEN_ISR_TABLES</span></code></a>
It produces a binary where sizes are fixed and thus the size must not change
between the intermediate binary and the final binary.</p>
</dd>
</dl>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-build-phase-4.svg"><img alt="Zephyr's build stage IV" src="../../_images/build-build-phase-4.svg" width="80%" /></a>
</div>
</div>
<div class="section" id="intermediate-binaries-post-processing">
<h5>Intermediate binaries post-processing<a class="headerlink" href="#intermediate-binaries-post-processing" title="Permalink to this headline">¶</a></h5>
<p>The binaries from the previous stage are incomplete, with empty and/or
placeholder sections that must be filled in by, essentially, reflection.</p>
<p>To complete the build procedure the following scripts are executed on the
intermediate binaries to produce the missing pieces needed for the final
binary.</p>
<p>When <a class="reference internal" href="../../reference/usermode/index.html#usermode-api"><span class="std std-ref">User Mode</span></a> is enabled:</p>
<dl class="simple">
<dt>Partition alignment</dt><dd><p>The <em>gen_app_partitions.py</em> script scans the unfixed size binary and
generates an app shared memory aligned linker script snippet where the
partitions are sorted in descending order.</p>
</dd>
</dl>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-postprocess-1.svg"><img alt="Zephyr's intermediate binary post-process I" src="../../_images/build-postprocess-1.svg" width="80%" /></a>
</div>
<p>When <a class="reference internal" href="../../reference/devicetree/index.html#devicetree"><span class="std std-ref">Devicetree</span></a> is used:</p>
<dl class="simple">
<dt>Device dependencies</dt><dd><p>The <em>gen_handles.py</em> script scans the unfixed size binary to determine
relationships between devices that were recorded from devicetree data,
and replaces the encoded relationships with values that are optimized to
locate the devices actually present in the application.</p>
</dd>
</dl>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-postprocess-2.svg"><img alt="Zephyr's intermediate binary post-process II" src="../../_images/build-postprocess-2.svg" width="80%" /></a>
</div>
<dl class="simple">
<dt>When <a class="reference internal" href="../../kconfig.html#CONFIG_GEN_ISR_TABLES" title="CONFIG_GEN_ISR_TABLES"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_GEN_ISR_TABLES</span></code></a> is enabled:</dt><dd><p>The <em>gen_isr_tables.py</em> script scant the fixed size binary and creates
an isr_tables.c source file with a hardware vector table and/or software
IRQ table.</p>
</dd>
</dl>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-postprocess-3.svg"><img alt="Zephyr's intermediate binary post-process III" src="../../_images/build-postprocess-3.svg" width="80%" /></a>
</div>
<p>When <a class="reference internal" href="../../reference/usermode/index.html#usermode-api"><span class="std std-ref">User Mode</span></a> is enabled:</p>
<dl class="simple">
<dt>Kernel object hashing</dt><dd><p>The <em>gen_kobject_list.py</em> scans the <em>ELF DWARF</em>
debug data to find the address of the all kernel objects. This
list is passed to <em>gperf</em>, which generates a perfect hash function and
table of those addresses, then that output is optimized by
<em>process_gperf.py</em>, using known properties of our special case.</p>
</dd>
</dl>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-postprocess-4.svg"><img alt="Zephyr's intermediate binary post-process IV" src="../../_images/build-postprocess-4.svg" width="80%" /></a>
</div>
<p>When no intermediate binary post-processing is required then the first
intermediate binary will be directly used as the final binary.</p>
</div>
<div class="section" id="final-binary">
<h5>Final binary<a class="headerlink" href="#final-binary" title="Permalink to this headline">¶</a></h5>
<p>The binary from the previous stage is incomplete, with empty and/or
placeholder sections that must be filled in by, essentially, reflection.</p>
<p>The link from the previous stage is repeated, this time with the missing
pieces populated.</p>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-build-phase-5.svg"><img alt="Zephyr's build final stage" src="../../_images/build-build-phase-5.svg" width="80%" /></a>
</div>
</div>
<div class="section" id="post-processing">
<h5>Post processing<a class="headerlink" href="#post-processing" title="Permalink to this headline">¶</a></h5>
<p>Finally, if necessary, the completed kernel is converted from <em>ELF</em> to
the format expected by the loader and/or flash tool required by the
target. This is accomplished in a straightforward manner with <em>objdump</em>.</p>
<div class="align-center figure">
<a class="reference internal image-reference" href="../../_images/build-build-phase-6.svg"><img alt="Zephyr's build final stage post-process" src="../../_images/build-build-phase-6.svg" width="80%" /></a>
</div>
</div>
</div>
</div>
<div class="section" id="supporting-scripts-and-tools">
<span id="build-system-scripts"></span><h3>Supporting Scripts and Tools<a class="headerlink" href="#supporting-scripts-and-tools" title="Permalink to this headline">¶</a></h3>
<p>The following is a detailed description of the scripts used during the build process.</p>
<div class="section" id="scripts-gen-syscalls-py">
<span id="gen-syscalls-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/gen_syscalls.py">scripts/gen_syscalls.py</a><a class="headerlink" href="#scripts-gen-syscalls-py" title="Permalink to this headline">¶</a></h4>
<p>Script to generate system call invocation macros</p>
<p>This script parses the system call metadata JSON file emitted by
parse_syscalls.py to create several files:</p>
<ul class="simple">
<li><p>A file containing weak aliases of any potentially unimplemented system calls,
as well as the system call dispatch table, which maps system call type IDs
to their handler functions.</p></li>
<li><p>A header file defining the system call type IDs, as well as function
prototypes for all system call handler functions.</p></li>
<li><p>A directory containing header files. Each header corresponds to a header
that was identified as containing system call declarations. These
generated headers contain the inline invocation functions for each system
call in that header.</p></li>
</ul>
</div>
<div class="section" id="scripts-gen-handles-py">
<span id="gen-handles-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/gen_handles.py">scripts/gen_handles.py</a><a class="headerlink" href="#scripts-gen-handles-py" title="Permalink to this headline">¶</a></h4>
<p>Translate generic handles into ones optimized for the application.</p>
<p>Immutable device data includes information about dependencies,
e.g. that a particular sensor is controlled through a specific I2C bus
and that it signals event on a pin on a specific GPIO controller.
This information is encoded in the first-pass binary using identifiers
derived from the devicetree.  This script extracts those identifiers
and replaces them with ones optimized for use with the devices
actually present.</p>
<p>For example the sensor might have a first-pass handle defined by its
devicetree ordinal 52, with the I2C driver having ordinal 24 and the
GPIO controller ordinal 14.  The runtime ordinal is the index of the
corresponding device in the static devicetree array, which might be 6,
5, and 3, respectively.</p>
<p>The output is a C source file that provides alternative definitions
for the array contents referenced from the immutable device objects.
In the final link these definitions supersede the ones in the
driver-specific object file.</p>
</div>
<div class="section" id="scripts-gen-kobject-list-py">
<span id="gen-kobject-list-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/gen_kobject_list.py">scripts/gen_kobject_list.py</a><a class="headerlink" href="#scripts-gen-kobject-list-py" title="Permalink to this headline">¶</a></h4>
<p>Script to generate gperf tables of kernel object metadata</p>
<p>User mode threads making system calls reference kernel objects by memory
address, as the kernel/driver APIs in Zephyr are the same for both user
and supervisor contexts. It is necessary for the kernel to be able to
validate accesses to kernel objects to make the following assertions:</p>
<blockquote>
<div><ul class="simple">
<li><p>That the memory address points to a kernel object</p></li>
<li><p>The kernel object is of the expected type for the API being invoked</p></li>
<li><p>The kernel object is of the expected initialization state</p></li>
<li><p>The calling thread has sufficient permissions on the object</p></li>
</ul>
</div></blockquote>
<p>For more details see the <a class="reference internal" href="../../reference/usermode/kernelobjects.html#kernelobjects"><span class="std std-ref">Kernel Objects</span></a> section in the documentation.</p>
<p>The zephyr build generates an intermediate ELF binary, zephyr_prebuilt.elf,
which this script scans looking for kernel objects by examining the DWARF
debug information to look for instances of data structures that are considered
kernel objects. For device drivers, the API struct pointer populated at build
time is also examined to disambiguate between various device driver instances
since they are all ‘struct device’.</p>
<p>This script can generate five different output files:</p>
<blockquote>
<div><ul class="simple">
<li><p>A gperf script to generate the hash table mapping kernel object memory
addresses to kernel object metadata, used to track permissions,
object type, initialization state, and any object-specific data.</p></li>
<li><p>A header file containing generated macros for validating driver instances
inside the system call handlers for the driver subsystem APIs.</p></li>
<li><p>A code fragment included by kernel.h with one enum constant for
each kernel object type and each driver instance.</p></li>
<li><p>The inner cases of a switch/case C statement, included by
kernel/userspace.c, mapping the kernel object types and driver
instances to their human-readable representation in the
otype_to_str() function.</p></li>
<li><p>The inner cases of a switch/case C statement, included by
kernel/userspace.c, mapping kernel object types to their sizes.
This is used for allocating instances of them at runtime
(CONFIG_DYNAMIC_OBJECTS) in the obj_size_get() function.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="scripts-gen-offset-header-py">
<span id="gen-offset-header-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/gen_offset_header.py">scripts/gen_offset_header.py</a><a class="headerlink" href="#scripts-gen-offset-header-py" title="Permalink to this headline">¶</a></h4>
<p>This script scans a specified object file and generates a header file
that defined macros for the offsets of various found structure members
(particularly symbols ending with <code class="docutils literal notranslate"><span class="pre">_OFFSET</span></code> or <code class="docutils literal notranslate"><span class="pre">_SIZEOF</span></code>), primarily
intended for use in assembly code.</p>
</div>
<div class="section" id="scripts-parse-syscalls-py">
<span id="parse-syscalls-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/parse_syscalls.py">scripts/parse_syscalls.py</a><a class="headerlink" href="#scripts-parse-syscalls-py" title="Permalink to this headline">¶</a></h4>
<p>Script to scan Zephyr include directories and emit system call and subsystem metadata</p>
<p>System calls require a great deal of boilerplate code in order to implement
completely. This script is the first step in the build system’s process of
auto-generating this code by doing a text scan of directories containing
C or header files, and building up a database of system calls and their
function call prototypes. This information is emitted to a generated
JSON file for further processing.</p>
<p>This script also scans for struct definitions such as __subsystem and
__net_socket, emitting a JSON dictionary mapping tags to all the struct
declarations found that were tagged with them.</p>
<p>If the output JSON file already exists, its contents are checked against
what information this script would have outputted; if the result is that the
file would be unchanged, it is not modified to prevent unnecessary
incremental builds.</p>
</div>
<div class="section" id="arch-x86-gen-idt-py">
<span id="gen-idt-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/arch/x86/gen_idt.py">arch/x86/gen_idt.py</a><a class="headerlink" href="#arch-x86-gen-idt-py" title="Permalink to this headline">¶</a></h4>
<p>Generate Interrupt Descriptor Table for x86 CPUs.</p>
<p>This script generates the interrupt descriptor table (IDT) for x86.
Please consult the IA Architecture SW Developer Manual, volume 3,
for more details on this data structure.</p>
<p>This script accepts as input the zephyr_prebuilt.elf binary,
which is a link of the Zephyr kernel without various build-time
generated data structures (such as the IDT) inserted into it.
This kernel image has been properly padded such that inserting
these data structures will not disturb the memory addresses of
other symbols. From the kernel binary we read a special section
“intList” which contains the desired interrupt routing configuration
for the kernel, populated by instances of the IRQ_CONNECT() macro.</p>
<p>This script outputs three binary tables:</p>
<ol class="arabic simple">
<li><p>The interrupt descriptor table itself.</p></li>
<li><p>A bitfield indicating which vectors in the IDT are free for
installation of dynamic interrupts at runtime.</p></li>
<li><p>An array which maps configured IRQ lines to their associated
vector entries in the IDT, used to program the APIC at runtime.</p></li>
</ol>
</div>
<div class="section" id="arch-x86-gen-gdt-py">
<span id="gen-gdt-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/arch/x86/gen_gdt.py">arch/x86/gen_gdt.py</a><a class="headerlink" href="#arch-x86-gen-gdt-py" title="Permalink to this headline">¶</a></h4>
<p>Generate a Global Descriptor Table (GDT) for x86 CPUs.</p>
<p>For additional detail on GDT and x86 memory management, please
consult the IA Architecture SW Developer Manual, vol. 3.</p>
<p>This script accepts as input the zephyr_prebuilt.elf binary,
which is a link of the Zephyr kernel without various build-time
generated data structures (such as the GDT) inserted into it.
This kernel image has been properly padded such that inserting
these data structures will not disturb the memory addresses of
other symbols.</p>
<p>The input kernel ELF binary is used to obtain the following
information:</p>
<ul class="simple">
<li><p>Memory addresses of the Main and Double Fault TSS structures
so GDT descriptors can be created for them</p></li>
<li><p>Memory addresses of where the GDT lives in memory, so that this
address can be populated in the GDT pseudo descriptor</p></li>
<li><p>whether userspace or HW stack protection are enabled in Kconfig</p></li>
</ul>
<p>The output is a GDT whose contents depend on the kernel
configuration. With no memory protection features enabled,
we generate flat 32-bit code and data segments. If hardware-
based stack overflow protection or userspace is enabled,
we additionally create descriptors for the main and double-
fault IA tasks, needed for userspace privilege elevation and
double-fault handling. If userspace is enabled, we also create
flat code/data segments for ring 3 execution.</p>
</div>
<div class="section" id="scripts-gen-relocate-app-py">
<span id="gen-relocate-app-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/gen_relocate_app.py">scripts/gen_relocate_app.py</a><a class="headerlink" href="#scripts-gen-relocate-app-py" title="Permalink to this headline">¶</a></h4>
<p>This script will relocate .text, .rodata, .data and .bss sections from required files
and places it in the required memory region. This memory region and file
are given to this python script in the form of a string.</p>
<p>Example of such a string would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SRAM2</span><span class="p">:</span><span class="n">COPY</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">xyz</span><span class="o">/</span><span class="n">zephyr</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">hello_world</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>\
<span class="n">SRAM1</span><span class="p">:</span><span class="n">COPY</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">xyz</span><span class="o">/</span><span class="n">zephyr</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">hello_world</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> \
<span class="n">FLASH2</span><span class="p">:</span><span class="n">NOCOPY</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">xyz</span><span class="o">/</span><span class="n">zephyr</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">hello_world</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main3</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
<p>To invoke this script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">gen_relocate_app</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">i</span> <span class="n">input_string</span> <span class="o">-</span><span class="n">o</span> <span class="n">generated_linker</span> <span class="o">-</span><span class="n">c</span> <span class="n">generated_code</span>
</pre></div>
</div>
<p>Configuration that needs to be sent to the python script.</p>
<ul class="simple">
<li><p>If the memory is like SRAM1/SRAM2/CCD/AON then place full object in
the sections</p></li>
<li><p>If the memory type is appended with _DATA / _TEXT/ _RODATA/ _BSS only the
selected memory is placed in the required memory region. Others are
ignored.</p></li>
<li><p>COPY/NOCOPY defines whether the script should generate the relocation code in
code_relocation.c or not</p></li>
</ul>
<p>Multiple regions can be appended together like SRAM2_DATA_BSS
this will place data and bss inside SRAM2.</p>
</div>
<div class="section" id="scripts-process-gperf-py">
<span id="process-gperf-py"></span><h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/process_gperf.py">scripts/process_gperf.py</a><a class="headerlink" href="#scripts-process-gperf-py" title="Permalink to this headline">¶</a></h4>
<p>gperf C file post-processor</p>
<p>We use gperf to build up a perfect hashtable of pointer values. The way gperf
does this is to create a table ‘wordlist’ indexed by a string representation
of a pointer address, and then doing memcmp() on a string passed in for
comparison</p>
<p>We are exclusively working with 4-byte pointer values. This script adjusts
the generated code so that we work with pointers directly and not strings.
This saves a considerable amount of space.</p>
</div>
<div class="section" id="scripts-gen-app-partitions-py">
<h4><a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/scripts/gen_app_partitions.py">scripts/gen_app_partitions.py</a><a class="headerlink" href="#scripts-gen-app-partitions-py" title="Permalink to this headline">¶</a></h4>
<p>Script to generate a linker script organizing application memory partitions</p>
<p>Applications may declare build-time memory domain partitions with
K_APPMEM_PARTITION_DEFINE, and assign globals to them using K_APP_DMEM
or K_APP_BMEM macros. For each of these partitions, we need to
route all their data into appropriately-sized memory areas which meet the
size/alignment constraints of the memory protection hardware.</p>
<p>This linker script is created very early in the build process, before
the build attempts to link the kernel binary, as the linker script this
tool generates is a necessary pre-condition for kernel linking. We extract
the set of memory partitions to generate by looking for variables which
have been assigned to input sections that follow a defined naming convention.
We also allow entire libraries to be pulled in to assign their globals
to a particular memory partition via command line directives.</p>
<p>This script takes as inputs:</p>
<ul class="simple">
<li><p>The base directory to look for compiled objects</p></li>
<li><p>key/value pairs mapping static library files to what partitions their globals
should end up in.</p></li>
</ul>
<p>The output is a linker script fragment containing the definition of the
app shared memory section, which is further divided, for each partition
found, into data and BSS for each partition.</p>
</div>
</div>
</div>
<div class="section" id="configuration-system-kconfig">
<span id="kconfig"></span><h2>Configuration System (Kconfig)<a class="headerlink" href="#configuration-system-kconfig" title="Permalink to this headline">¶</a></h2>
<p>The Zephyr kernel and subsystems can be configured at build time to adapt them
for specific application and platform needs. Configuration is handled through
Kconfig, which is the same configuration system used by the Linux kernel. The
goal is to support configuration without having to change any source code.</p>
<p>Configuration options (often called <em>symbols</em>) are defined in <code class="file docutils literal notranslate"><span class="pre">Kconfig</span></code>
files, which also specify dependencies between symbols that determine what
configurations are valid. Symbols can be grouped into menus and sub-menus to
keep the interactive configuration interfaces organized.</p>
<p>The output from Kconfig is a header file <code class="file docutils literal notranslate"><span class="pre">autoconf.h</span></code> with macros that
can be tested at build time. Code for unused features can be compiled out to
save space.</p>
<p>The following sections explain how to set Kconfig configuration options, go
into detail on how Kconfig is used within the Zephyr project, and have some
tips and best practices for writing <code class="file docutils literal notranslate"><span class="pre">Kconfig</span></code> files.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="kconfig/menuconfig.html">Interactive Kconfig interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="kconfig/setting.html">Setting Kconfig configuration values</a></li>
<li class="toctree-l1"><a class="reference internal" href="kconfig/tips.html">Kconfig - Tips and Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="kconfig/preprocessor-functions.html">Custom Kconfig Preprocessor Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="kconfig/extensions.html">Kconfig extensions</a></li>
</ul>
</div>
<p>Users interested in optimizing their configuraion for security should refer
to the Zephyr Security Guide’s section on the <a class="reference internal" href="../../security/hardening-tool.html#hardening"><span class="std std-ref">Hardening Tool</span></a>.</p>
</div>
</div>


           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2015-2022 Zephyr Project members and individual contributors.
      <span class="lastupdated">Last updated on Mar 05, 2022.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>