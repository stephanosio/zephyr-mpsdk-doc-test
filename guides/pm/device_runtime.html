<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device Runtime Power Management &mdash; Zephyr Project Documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script type="module" src="../../_static/js/dark-mode-toggle.min.mjs"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-831873-47"></script>
        <script src="../../_static/js/ga-tracker.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="Power Domain" href="power_domain.html" />
    <link rel="prev" title="Device Power Management Infrastructure" href="device.html" />
  <meta name="color-scheme" content="dark light">
  
  <link rel="stylesheet" href="../../_static/css/light.css" type="text/css" media="(prefers-color-scheme: light)"/>
  <link rel="stylesheet" href="../../_static/css/dark.css" type="text/css" media="(prefers-color-scheme: dark)"/>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.99
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Document Release Versions</dt>
        
          <dd><a href="/">latest</a></dd>
        
          <dd><a href="/3.0.0/">3.0.0</a></dd>
        
          <dd><a href="/2.7.0/">2.7.0</a></dd>
        
          <dd><a href="/2.6.0/">2.6.0</a></dd>
        
          <dd><a href="/2.5.0/">2.5.0</a></dd>
        
          <dd><a href="/2.4.0/">2.4.0</a></dd>
        
          <dd><a href="/2.3.0/">2.3.0</a></dd>
        
          <dd><a href="/1.14.1/">1.14.1</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
        <dd><a href="/latest/zephyr.pdf">PDF</a></dd>
      </dl>
      <dl>
        <dt>zephyrproject.org Links</dt>
          <dd>
            <a href="https://www.zephyrproject.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/sdk-ng/releases">SDK</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/zephyr/releases">Releases</a>
          </dd>
      </dl>
    </div>
  </div>
  
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build/index.html">Build and Configuration Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/index.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">API Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User and Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../beyond-GSG.html">Beyond the Getting Started Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arch/index.html">Architecture-related Guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/index.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../docs/index.html">Documentation Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../coccinelle.html">Coccinelle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../code-relocation.html">Code And Data Relocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto/index.html">Cryptography</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flash_debug/index.html">Flashing and Hardware Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debug_tools/index.html">Debugging and Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_mgmt/index.html">Device Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dts/index.html">Devicetree Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../env_vars.html">Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pinctrl/index.html">Pin Control</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Power Management</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="system.html">System Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="device.html">Device Power Management Infrastructure</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Device Runtime Power Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#design-principles">Design principles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-guidelines">Implementation guidelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="power_domain.html">Power Domain</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../emulator/index.html">Peripheral and Hardware Emulators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules.html">Modules (External projects)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platformio/index.html">Using with PlatformIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../portability/index.html">OS Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../porting/index.html">Porting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../smf/index.html">State Machine Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../test/index.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tfm/index.html">Trusted Firmware-M</a></li>
<li class="toctree-l2"><a class="reference internal" href="../west/index.html">West (Zephyr’s meta-tool)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimizations/index.html">Optimizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zephyr_cmake_package.html">Zephyr CMake Package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Release Notes</a></li>
</ul>

  
  <div class="toctree-wrapper compound">
    <p class="caption"><span class="caption-text">Reference</span></p>
    <ul>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/doxygen/html/index.html">API</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/kconfig.html">Kconfig Options</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/devicetree/bindings.html">Devicetree Bindings</a>
      </li>
      
    </ul>
  </div>
  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zephyr Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <!-- Docs / Latest -->
  
  

  <li><a href="../../index.html">Docs / Latest</a> &raquo;</li>
  
     <li><a href="../index.html">User and Developer Guides</a> &raquo;</li>
  
     <li><a href="index.html">Power Management</a> &raquo;</li>
  
  <li>Device Runtime Power Management</li>


  <li class="wy-breadcrumbs-aside">
    <dark-mode-toggle id="dark-mode-toggle" appearance="toggle" permanent="true"/>
  </li>
  <li class="wy-breadcrumbs-aside">
      
      
        <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/doc/guides/pm/device_runtime.rst" class="fa fa-github"> Open on GitHub</a>
      
    
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
    <div class="wy-alert wy-alert-danger">
     This is the documentation for the latest (main) development branch of
     Zephyr. If you are looking for the documentation of previous releases, use
     the drop-down menu on the left and select the desired version.
    </div>
  
  
           <div itemprop="articleBody">
             
  <div class="section" id="device-runtime-power-management">
<h1>Device Runtime Power Management<a class="headerlink" href="#device-runtime-power-management" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The device runtime power management (PM) framework is an active power management
mechanism which reduces the overall system power consumtion by suspending the
devices which are idle or not used independently of the system state. It can be
enabled by setting <a class="reference internal" href="../../kconfig.html#CONFIG_PM_DEVICE_RUNTIME" title="CONFIG_PM_DEVICE_RUNTIME"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_PM_DEVICE_RUNTIME</span></code></a>. In this model the device
driver is responsible to indicate when it needs the device and when it does not.
This information is used to determine when to suspend or resume a device based
on usage count.</p>
<p>When device runtime power management is enabled on a device, its state will be
initially set to a <a class="reference internal" href="../../reference/pm/index.html#c.pm_device_state.PM_DEVICE_STATE_SUSPENDED" title="PM_DEVICE_STATE_SUSPENDED"><code class="xref c c-enumerator docutils literal notranslate"><span class="pre">PM_DEVICE_STATE_SUSPENDED</span></code></a> indicating it is
not used. On the first device request, it will be resumed and so put into the
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_state.PM_DEVICE_STATE_ACTIVE" title="PM_DEVICE_STATE_ACTIVE"><code class="xref c c-enumerator docutils literal notranslate"><span class="pre">PM_DEVICE_STATE_ACTIVE</span></code></a> state. The device will remain in this
state until it is no longer used. At this point, the device will be suspended
until the next device request. If the suspension is performed synchronously the
device will be immediately put into the
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_state.PM_DEVICE_STATE_SUSPENDED" title="PM_DEVICE_STATE_SUSPENDED"><code class="xref c c-enumerator docutils literal notranslate"><span class="pre">PM_DEVICE_STATE_SUSPENDED</span></code></a> state, whereas if it is performed
asynchonously, it will be put into the
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_state.PM_DEVICE_STATE_SUSPENDING" title="PM_DEVICE_STATE_SUSPENDING"><code class="xref c c-enumerator docutils literal notranslate"><span class="pre">PM_DEVICE_STATE_SUSPENDING</span></code></a> state first and then into the
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_state.PM_DEVICE_STATE_SUSPENDED" title="PM_DEVICE_STATE_SUSPENDED"><code class="xref c c-enumerator docutils literal notranslate"><span class="pre">PM_DEVICE_STATE_SUSPENDED</span></code></a> state when the action is run.</p>
<div class="figure align-default" id="id1">
<div class="graphviz"><object data="../../_images/graphviz-005f62f954a628b6c2e28adbb87c0a980723d9b1.svg" type="image/svg+xml" class="graphviz">
<p class="warning">digraph {
     node [shape=box];
     init [shape=point];

     SUSPENDED [label=PM_DEVICE_STATE_SUSPENDED];
     ACTIVE [label=PM_DEVICE_STATE_ACTIVE];
     SUSPENDING [label=PM_DEVICE_STATE_SUSPENDING];

     init -&gt; SUSPENDED;
     SUSPENDED -&gt; ACTIVE;
     ACTIVE -&gt; SUSPENDED;
     ACTIVE -&gt; SUSPENDING [constraint=false]
     SUSPENDING -&gt; SUSPENDED [constraint=false];
     SUSPENDED -&gt; SUSPENDING [style=invis];
     SUSPENDING -&gt; ACTIVE [style=invis];
 }</p></object></div>
<p class="caption"><span class="caption-number">Fig. 28 </span><span class="caption-text">Device states and transitions</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>The device runtime power management framework has been designed to minimize
devices power consumption with minimal application work. Device drivers are
responsible for indicating when they need the device to be operational and
when they do not. Therefore, applications can not manually suspend or resume a
device. An application can, however, decide when to disable or enable runtime
power management for a device. This can be useful, for example, if an
application wants a particular device to be always active.</p>
</div>
<div class="section" id="design-principles">
<h2>Design principles<a class="headerlink" href="#design-principles" title="Permalink to this headline">¶</a></h2>
<p>When runtime PM is enabled on a device it will no longer be resumed or suspended
during system power transitions. Instead, the device is fully responsible to
indicate when it needs a device and when it does not. The device runtime PM API
uses reference counting to keep track of device’s usage. This allows the API to
determine when a device needs to be resumed or suspended. The API uses the <em>get</em>
and <em>put</em> terminology to indicate when a device is needed or not, respectively.
This mechanism plays a key role when we account for device dependencies. For
example, if a bus device is used by multiple sensors, we can keep the bus active
until the last sensor has finished using it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As of today, the device runtime power management API does not manage device
dependencies. This effectively means that, if a device depends on other
devices to operate (e.g. a sensor may depend on a bus device), the bus will
be resumed and suspended on every transaction. In general, it is more
efficient to keep parent devices active when their children are used, since
the children may perform multiple transactions in a short period of time.
Until this feature is added, devices can manually <em>get</em> or <em>put</em> their
dependencies.</p>
</div>
<p>The <a class="reference internal" href="../../reference/pm/index.html#c.pm_device_runtime_get" title="pm_device_runtime_get"><code class="xref c c-func docutils literal notranslate"><span class="pre">pm_device_runtime_get()</span></code></a> function can be used by a device driver to
indicate it <em>needs</em> the device to be active or operational. This function will
increase device usage count and resume the device if necessary. Similarly, the
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_runtime_put" title="pm_device_runtime_put"><code class="xref c c-func docutils literal notranslate"><span class="pre">pm_device_runtime_put()</span></code></a> function can be used to indicate that the device
is no longer needed. This function will decrease the device usage count and
suspend the device if necessary. It is worth to note that in both cases, the
operation is carried out synchronously. The sequence diagram shown in
<a class="reference internal" href="#pm-device-runtime-sync-ops"><span class="std std-numref">Fig. 29</span></a> illustrates how a device can use this API
and the expected sequence of events.</p>
<div class="figure align-default" id="id2">
<span id="pm-device-runtime-sync-ops"></span><img alt="../../_images/devr-sync-ops.svg" src="../../_images/devr-sync-ops.svg" /><p class="caption"><span class="caption-number">Fig. 29 </span><span class="caption-text">Synchronous operation on a single device</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>The synchronous model is as simple as it gets. However, it may introduce
unnecessary delays since the application will not get the operation result until
the device is suspended (in case device is no longer used). It will likely not
be a problem if the operation is fast, e.g. a register toggle. However, the
situation will not be the same if suspension involves sending packets through a
slow bus. For this reason the device drivers can also make use of the
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_runtime_put_async" title="pm_device_runtime_put_async"><code class="xref c c-func docutils literal notranslate"><span class="pre">pm_device_runtime_put_async()</span></code></a> function. This function will schedule
the suspend operation, again, if device is no longer used. The suspension will
then be carried out when the system work queue gets the chance to run. The
sequence diagram in <a class="reference internal" href="#pm-device-runtime-async-ops"><span class="std std-numref">Fig. 30</span></a> illustrates this
scenario.</p>
<div class="figure align-default" id="id3">
<span id="pm-device-runtime-async-ops"></span><img alt="../../_images/devr-async-ops.svg" src="../../_images/devr-async-ops.svg" /><p class="caption"><span class="caption-number">Fig. 30 </span><span class="caption-text">Asynchronous operation on a single device</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="implementation-guidelines">
<h2>Implementation guidelines<a class="headerlink" href="#implementation-guidelines" title="Permalink to this headline">¶</a></h2>
<p>In a first place, a device driver needs to implement the PM action callback used
by the PM subsystem to suspend or resume devices.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">mydev_pm_action</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="k">enum</span><span class="w"> </span><span class="n">pm_device_action</span><span class="w"> </span><span class="o">*</span><span class="n">action</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">PM_DEVICE_ACTION_SUSPEND</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* suspend the device */</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">PM_DEVICE_ACTION_RESUME</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* resume the device */</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOTSUP</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The PM action callback calls are serialized by the PM subsystem, therefore, no
special synchronization is required.</p>
<p>To enable device runtime power management on a device, the driver needs to call
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_runtime_enable" title="pm_device_runtime_enable"><code class="xref c c-func docutils literal notranslate"><span class="pre">pm_device_runtime_enable()</span></code></a> at initialization time. Note that this
function will suspend the device if its state is
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_state.PM_DEVICE_STATE_ACTIVE" title="PM_DEVICE_STATE_ACTIVE"><code class="xref c c-enumerator docutils literal notranslate"><span class="pre">PM_DEVICE_STATE_ACTIVE</span></code></a>. In case the device is physically
suspended, the init function should call
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_runtime_init_suspended" title="pm_device_runtime_init_suspended"><code class="xref c c-func docutils literal notranslate"><span class="pre">pm_device_runtime_init_suspended()</span></code></a> before calling
<a class="reference internal" href="../../reference/pm/index.html#c.pm_device_runtime_enable" title="pm_device_runtime_enable"><code class="xref c c-func docutils literal notranslate"><span class="pre">pm_device_runtime_enable()</span></code></a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* device driver initialization function */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">mydev_init</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* OPTIONAL: mark device as suspended if it is physically suspended */</span><span class="w"></span>
<span class="w">    </span><span class="n">pm_device_runtime_init_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* enable device runtime power management */</span><span class="w"></span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pm_device_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Assuming an example device driver that implements an <code class="docutils literal notranslate"><span class="pre">operation</span></code> API call, the
<em>get</em> and <em>put</em> operations could be carried out as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">mydev_operation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* &quot;get&quot; device (increases usage count, resumes device if suspended) */</span><span class="w"></span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pm_device_runtime_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* do something with the device */</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* &quot;put&quot; device (decreases usage count, suspends device if no more users) */</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pm_device_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In case the suspend operation is <em>slow</em>, the device driver can use the
asynchronous API:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">mydev_operation</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* &quot;get&quot; device (increases usage count, resumes device if suspended) */</span><span class="w"></span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pm_device_runtime_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* do something with the device */</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* &quot;put&quot; device (decreases usage count, schedule suspend if no more users) */</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pm_device_runtime_put_async</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2015-2022 Zephyr Project members and individual contributors.
      <span class="lastupdated">Last updated on Mar 05, 2022.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>