<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X-NUCLEO-IKS02A1 shield: Acquire MEMS microphones data &mdash; Zephyr Project Documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script type="module" src="../../../../_static/js/dark-mode-toggle.min.mjs"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-831873-47"></script>
        <script src="../../../../_static/js/ga-tracker.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../../copyright.html" />
    <link rel="next" title="X-NUCLEO-IKS02A1 shield: Sensorhub (Mode 2) sample" href="../sensorhub/README.html" />
    <link rel="prev" title="X-NUCLEO-IKS01A3: shield Standard (Mode 1) sample" href="../../x_nucleo_iks01a3/standard/README.html" />
  <meta name="color-scheme" content="dark light">
  
  <link rel="stylesheet" href="../../../../_static/css/light.css" type="text/css" media="(prefers-color-scheme: light)"/>
  <link rel="stylesheet" href="../../../../_static/css/dark.css" type="text/css" media="(prefers-color-scheme: dark)"/>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html">
            <img src="../../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.0-rc3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Document Release Versions</dt>
        
          <dd><a href="/">latest</a></dd>
        
          <dd><a href="/2.7.0/">2.7.0</a></dd>
        
          <dd><a href="/2.6.0/">2.6.0</a></dd>
        
          <dd><a href="/2.5.0/">2.5.0</a></dd>
        
          <dd><a href="/2.4.0/">2.4.0</a></dd>
        
          <dd><a href="/2.3.0/">2.3.0</a></dd>
        
          <dd><a href="/1.14.1/">1.14.1</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
        <dd><a href="/latest/zephyr.pdf">PDF</a></dd>
      </dl>
      <dl>
        <dt>zephyrproject.org Links</dt>
          <dd>
            <a href="https://www.zephyrproject.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/sdk-ng/releases">SDK</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/zephyr/releases">Releases</a>
          </dd>
      </dl>
    </div>
  </div>
  
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/build/index.html">Build and Configuration Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../application/index.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guides/index.html">User and Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../security/index.html">Security</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Samples and Demos</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../classic.html">Classic Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../basic/basic.html">Basic Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../userspace/index.html">Userspace Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../subsys/subsys.html">Various Subsystems Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../net/net.html">Networking Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../bluetooth/bluetooth.html">Bluetooth samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../sensor/sensor.html">Sensor Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../arch/index.html">Architecture Dependent Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../boards/boards.html">Board-specific samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../drivers/drivers.html">Driver Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../application_development/application_development.html">Application development samples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../shields.html">Shields Samples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../lmp90100_evb/lmp90100_evb.html">LMP90100 Sensor AFE Evaluation Board Shield Samples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../lmp90100_evb/rtd/README.html">LMP90100 Sensor AFE Evaluation Board: RTD Sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../x_nucleo_iks01a1/README.html">X-NUCLEO-IKS01A1: MEMS inertial and environmental multi-sensor shield</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../x_nucleo_iks01a2/sensorhub/README.html">X-NUCLEO-IKS01A2: shield SensorHub (Mode 2) sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../x_nucleo_iks01a2/standard/README.html">X-NUCLEO-IKS01A2: shield Standard (Mode 1) sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../x_nucleo_iks01a3/sensorhub/README.html">X-NUCLEO-IKS01A3: shield (Mode 2) sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../x_nucleo_iks01a3/standard/README.html">X-NUCLEO-IKS01A3: shield Standard (Mode 1) sample</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">X-NUCLEO-IKS02A1 shield: Acquire MEMS microphones data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#references">References</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-and-running">Building and Running</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../sensorhub/README.html">X-NUCLEO-IKS02A1 shield: Sensorhub (Mode 2) sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../standard/README.html">X-NUCLEO-IKS02A1 shield: Standard (Mode 1) sample</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../posix/posix.html">POSIX Subsystem Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../kernel/index.html">Various Kernel and Scheduler Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tfm_integration/tfm_integration.html">TF-M Integration Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tfm_integration/tfm_integration.html#trusted-firmware-m-tf-m">Trusted Firmware-M (TF-M)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html">External Module Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../compression/compression.html">Compression Samples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../releases/index.html">Release Notes</a></li>
</ul>

  
  <div class="toctree-wrapper compound">
    <p class="caption"><span class="caption-text">Reference</span></p>
    <ul>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/doxygen/html/index.html">API</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/kconfig/index.html">Kconfig Options</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/devicetree/bindings.html">Devicetree Bindings</a>
      </li>
      
    </ul>
  </div>
  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Zephyr Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <!-- Docs / Latest -->
  
  

  <li><a href="../../../../index.html">Docs / Latest</a> &raquo;</li>
  
     <li><a href="../../../index.html">Samples and Demos</a> &raquo;</li>
  
     <li><a href="../../shields.html">Shields Samples</a> &raquo;</li>
  
  <li>X-NUCLEO-IKS02A1 shield: Acquire MEMS microphones data</li>


  <li class="wy-breadcrumbs-aside">
    <dark-mode-toggle id="dark-mode-toggle" appearance="toggle" permanent="true"/>
  </li>
  <li class="wy-breadcrumbs-aside">
      
      
        <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main//samples/shields/x_nucleo_iks02a1/microphone/README.rst" class="fa fa-github"> Open on GitHub</a>
      
    
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
    <div class="wy-alert wy-alert-danger">
     This is the documentation for the latest (main) development branch of
     Zephyr. If you are looking for the documentation of previous releases, use
     the drop-down menu on the left and select the desired version.
    </div>
  
  
           <div itemprop="articleBody">
             
  <div class="section" id="x-nucleo-iks02a1-shield-acquire-mems-microphones-data">
<span id="x-nucleo-iks02a1-mic-sample"></span><h1>X-NUCLEO-IKS02A1 shield: Acquire MEMS microphones data<a class="headerlink" href="#x-nucleo-iks02a1-shield-acquire-mems-microphones-data" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This sample enables the digital MEMS microphone on X-NUCLEO-IKS02A1
shields</p>
<p>This sample provides an example of how to acquire audio through
the digital MEMS microphones on X-NUCLEO-IKS02A1 shield.
The microphone generates a PDM stream which is acquired through I2S.
The PDM stream is then converted to PCM using the OpenPDM2PCM library
available in zephyrproject/modules/hal/st/audio/microphone.</p>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>This sample communicates over I2C with the X-NUCLEO-IKS02A1 shield
stacked on a board with an Arduino connector.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please note that, in order to make the shield working on top of this board,
it is needed to have SB24 and SB29 solder bridges properly closed. In this way
the PDM microphone clock and data lines get connected to SPI clock and MOSI.
Similar consideration may apply to other boards as well.</p>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>X-NUCLEO-IKS02A1: <a class="reference external" href="https://www.st.com/en/ecosystems/x-nucleo-iks02a1.html">https://www.st.com/en/ecosystems/x-nucleo-iks02a1.html</a></p></li>
</ul>
</div>
<div class="section" id="building-and-running">
<h2>Building and Running<a class="headerlink" href="#building-and-running" title="Permalink to this headline">¶</a></h2>
<p>This sample runs with X-NUCLEO-IKS02A1 stacked on any board with a matching
Arduino connector. For this example, we use a <a class="reference internal" href="../../../../boards/arm/nucleo_f411re/doc/index.html#nucleo-f411re-board"><span class="std std-ref">ST Nucleo F411RE</span></a> board.
To build the sample you can use following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">west build -b nucleo_f411re samples/shields/x_nucleo_iks02a1/microphone/</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case a different board is used, one of the things that must be verified before
building the sample is the I2S output clock frequency configuration. For example,
for nucleo_f411re board, we have the following file that configures the I2SPLL and
have a dependency on HSE/HSI:
<a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/boards/shields/x_nucleo_iks02a1/boards/nucleo_f411re.defconfig">boards/shields/x_nucleo_iks02a1/boards/nucleo_f411re.defconfig</a></p>
<p>The user is invited to to verify which osci is configured on the used host board
defconfig file and calculate the final I2SClk frequency, e.g.
<a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/boards/arm/nucleo_f411re/nucleo_f411re.dts">boards/arm/nucleo_f411re/nucleo_f411re.dts</a></p>
</div>
<div class="section" id="sample-output">
<h3>Sample Output<a class="headerlink" href="#sample-output" title="Permalink to this headline">¶</a></h3>
<p>The example acquires one second of audio and prints out the PCM stream on COM port.
The acquisition starts immediately after the reset button is pressed.</p>
<p>The characteristics of the PCM audio are hardcoded in the example:</p>
<ul class="simple">
<li><p>16KHz sample rate</p></li>
<li><p>16 bits per sample</p></li>
<li><p>1 channel (mono)</p></li>
</ul>
<p>One second of acquisition at a 1 channel 16KHz sampling rate yields 16,000 16-bit samples.
The microphone PDM requested clock should lead the MP34DT05 driver to select an
oversampling/decimation factor to result in approximately a 2MHz bit clock.</p>
<p>See PCM and PDM configuration in file <a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/samples/shields/x_nucleo_iks02a1/microphone/src/main.c">samples/shields/x_nucleo_iks02a1/microphone/src/main.c</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible to change the AUDIO_FREQ to 32000 acquiring only 500 ms.</p>
</div>
<p>At the end of the acquisition the PCM data will be printed on the terminal
emulator in either binary or ASCII format. The output is controlled by the
<code class="xref c c-macro docutils literal notranslate"><span class="pre">PCM_OUTPUT_IN_ASCII</span></code> macro, off by default, in
<a class="reference external" href="https://github.com/zephyrproject-rtos/zephyr/blob/main/samples/shields/x_nucleo_iks02a1/microphone/src/main.c">samples/shields/x_nucleo_iks02a1/microphone/src/main.c</a>.</p>
<div class="section" id="binary-pcm-output">
<h4>Binary PCM Output<a class="headerlink" href="#binary-pcm-output" title="Permalink to this headline">¶</a></h4>
<p>The Nucleo F411RE board presents itself to the host
as a USB CDC class, and will use <code class="docutils literal notranslate"><span class="pre">/dev/ttyACM0</span></code>
device for communication. The <code class="docutils literal notranslate"><span class="pre">/dev/ttyACM0</span></code> port
must be configured in raw mode to avoid having
special characters (such as <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">CTRL</kbd>-<kbd class="kbd docutils literal notranslate">Z</kbd></kbd> or <kbd class="kbd compound docutils literal notranslate"><kbd class="kbd docutils literal notranslate">CTRL</kbd>-<kbd class="kbd docutils literal notranslate">D</kbd></kbd>)
processed and ‘cooked out’.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">stty -F /dev/ttyACM0 115200 raw</span>
<span class="go">cat /dev/ttyACM0 &gt; /tmp/sound.raw</span>
<span class="go">dos2unix -f /tmp/sound.raw</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The dos2unix command is used to recover the situation in which the character 0x0a is
interpreted as NL and an 0x0d (CR) is added. If you don’t remove it the audio stream would
get corrupted.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The /tmp/sound.raw file final size should result exactly of 32000 byte, but sometimes may
happen that 1 or 2 spurious 0x00 bytes are put at the beginning. In this case the user
may get rid of them using the following linux command (change <code class="docutils literal notranslate"><span class="pre">skip</span></code> value according
to number of spurious bytes to be removed):</p>
<p>dd if=sound.raw of=sound_clean.raw bs=1 skip=1</p>
</div>
</div>
<div class="section" id="ascii-pcm-output">
<h4>ASCII PCM Output<a class="headerlink" href="#ascii-pcm-output" title="Permalink to this headline">¶</a></h4>
<p>It is also possible to recompile and to have PCM output in ASCII, which needs
to be converted to binary later on. The output format is the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">-- start</span>
<span class="go">0xfbe0,</span>
<span class="go">0xfbf0,</span>
<span class="go">0xfc0c,</span>
<span class="go">0xfc24,</span>
<span class="go">0xfc3c,</span>
<span class="go">0xfc4c,</span>
<span class="go">0xfc68,</span>
<span class="go">0xfc48,</span>

<span class="go">[...]</span>

<span class="go">0xfb98,</span>
<span class="go">0xfb98,</span>
<span class="go">0xfbb8,</span>
<span class="go">0xfbac,</span>
<span class="go">0xfbc4,</span>
<span class="go">0xfbe8,</span>
<span class="go">0xfbf4,</span>
<span class="go">-- end</span>
</pre></div>
</div>
</div>
<div class="section" id="play-pcm-audio">
<h4>Play PCM Audio<a class="headerlink" href="#play-pcm-audio" title="Permalink to this headline">¶</a></h4>
<p>Now that we have a binary PCM file (say sound.raw), you can use,
for example, the audacity open source editor/player to load and play it.</p>
<p>Use the ‘Import-&gt;Raw Data’ menu to load the sound.raw file as
signed 16 bit PCM, Little Endian, mono format &#64;16KHz:</p>
<a class="reference internal image-reference" href="../../../../_images/audio_import.png"><img alt="audio_import" class="align-center" src="../../../../_images/audio_import.png" style="width: 274px; height: 307px;" /></a>
<p>After the file is imported you can analyze and play the 1sec audio file:</p>
<a class="reference internal image-reference" href="../../../../_images/audio_file.png"><img alt="audio_file" class="align-center" src="../../../../_images/audio_file.png" style="width: 1627px; height: 505px;" /></a>
</div>
</div>
</div>
</div>


           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../../copyright.html">Copyright</a> 2015-2021 Zephyr Project members and individual contributors.
      <span class="lastupdated">Last updated on Feb 21, 2022.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>