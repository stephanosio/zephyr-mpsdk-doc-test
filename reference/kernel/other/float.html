<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Floating Point Services &mdash; Zephyr Project Documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script type="module" src="../../../_static/js/dark-mode-toggle.min.mjs"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-831873-47"></script>
        <script src="../../../_static/js/ga-tracker.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" />
    <link rel="next" title="C++ Support for Applications" href="cxx_support.html" />
    <link rel="prev" title="Atomic Services" href="atomic.html" />
  <meta name="color-scheme" content="dark light">
  
  <link rel="stylesheet" href="../../../_static/css/light.css" type="text/css" media="(prefers-color-scheme: light)"/>
  <link rel="stylesheet" href="../../../_static/css/dark.css" type="text/css" media="(prefers-color-scheme: dark)"/>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html">
            <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.99
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Document Release Versions</dt>
        
          <dd><a href="/">latest</a></dd>
        
          <dd><a href="/3.0.0/">3.0.0</a></dd>
        
          <dd><a href="/2.7.0/">2.7.0</a></dd>
        
          <dd><a href="/2.6.0/">2.6.0</a></dd>
        
          <dd><a href="/2.5.0/">2.5.0</a></dd>
        
          <dd><a href="/2.4.0/">2.4.0</a></dd>
        
          <dd><a href="/2.3.0/">2.3.0</a></dd>
        
          <dd><a href="/1.14.1/">1.14.1</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
        <dd><a href="/latest/zephyr.pdf">PDF</a></dd>
      </dl>
      <dl>
        <dt>zephyrproject.org Links</dt>
          <dd>
            <a href="https://www.zephyrproject.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/sdk-ng/releases">SDK</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/zephyr/releases">Releases</a>
          </dd>
      </dl>
    </div>
  </div>
  
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/build/index.html">Build and Configuration Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../application/index.html">Application Development</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../api/index.html">API Status and Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../audio/index.html">Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../misc/notify.html">Asynchronous Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bluetooth/index.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../canbus/index.html">Controller Area Network (CAN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crypto/index.html">Crypto</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../devicetree/index.html">Devicetree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../drivers/index.html">Device Driver Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../display/index.html">Display Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../edac/index.html">Error Detection And Correction (EDAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../file_system/index.html">File Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iterable_sections/index.html">Iterable Sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../misc/formatted_output.html">Formatted Output</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Kernel Services</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../index.html#scheduling-interrupts-and-synchronization">Scheduling, Interrupts, and Synchronization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#data-passing">Data Passing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#memory-management">Memory Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#timing">Timing</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html#other">Other</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="cpu_idle.html">CPU Idling</a></li>
<li class="toctree-l4"><a class="reference internal" href="atomic.html">Atomic Services</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Floating Point Services</a></li>
<li class="toctree-l4"><a class="reference internal" href="cxx_support.html">C++ Support for Applications</a></li>
<li class="toctree-l4"><a class="reference internal" href="version.html">Version</a></li>
<li class="toctree-l4"><a class="reference internal" href="fatal.html">Fatal Errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="thread_local_storage.html">Thread Local Storage (TLS)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../libc/index.html">C standard library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging/index.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../memory_management/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../misc/index.html">Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_structures/index.html">Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../modbus/index.html">Modbus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../peripherals/index.html">Peripherals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinctrl/index.html">Pin Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pm/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../random/index.html">Random Number Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../resource_management/index.html">Resource Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../shell/index.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../storage/index.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../task_wdt/index.html">Task Watchdog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../misc/timeutil.html">Time Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usb/index.html">USB device support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usermode/index.html">User Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../util/index.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../settings/index.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../timing_functions/index.html">Executing Time Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtualization/index.html">Virtualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">User and Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../samples/index.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/index.html">Release Notes</a></li>
</ul>

  
  <div class="toctree-wrapper compound">
    <p class="caption"><span class="caption-text">Reference</span></p>
    <ul>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/doxygen/html/index.html">API</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/kconfig.html">Kconfig Options</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/devicetree/bindings.html">Devicetree Bindings</a>
      </li>
      
    </ul>
  </div>
  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Zephyr Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <!-- Docs / Latest -->
  
  

  <li><a href="../../../index.html">Docs / Latest</a> &raquo;</li>
  
     <li><a href="../../index.html">API Reference</a> &raquo;</li>
  
     <li><a href="../index.html">Kernel Services</a> &raquo;</li>
  
  <li>Floating Point Services</li>


  <li class="wy-breadcrumbs-aside">
    <dark-mode-toggle id="dark-mode-toggle" appearance="toggle" permanent="true"/>
  </li>
  <li class="wy-breadcrumbs-aside">
      
      
        <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/doc/reference/kernel/other/float.rst" class="fa fa-github"> Open on GitHub</a>
      
    
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
    <div class="wy-alert wy-alert-danger">
     This is the documentation for the latest (main) development branch of
     Zephyr. If you are looking for the documentation of previous releases, use
     the drop-down menu on the left and select the desired version.
    </div>
  
  
           <div itemprop="articleBody">
             
  <div class="section" id="floating-point-services">
<span id="float-v2"></span><h1>Floating Point Services<a class="headerlink" href="#floating-point-services" title="Permalink to this headline">¶</a></h1>
<p>The kernel allows threads to use floating point registers on board
configurations that support these registers.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Floating point services are currently available only for boards
based on ARM Cortex-M SoCs supporting the Floating Point Extension,
the Intel x86 architecture, the SPARC architecture and ARCv2 SoCs
supporting the Floating Point Extension. The services provided
are architecture specific.</p>
<p>The kernel does not support the use of floating point registers by ISRs.</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#concepts" id="id1">Concepts</a></p>
<ul>
<li><p><a class="reference internal" href="#no-fp-registers-mode" id="id2">No FP registers mode</a></p></li>
<li><p><a class="reference internal" href="#unshared-fp-registers-mode" id="id3">Unshared FP registers mode</a></p></li>
<li><p><a class="reference internal" href="#shared-fp-registers-mode" id="id4">Shared FP registers mode</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#implementation" id="id5">Implementation</a></p>
<ul>
<li><p><a class="reference internal" href="#performing-floating-point-arithmetic" id="id6">Performing Floating Point Arithmetic</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#suggested-uses" id="id7">Suggested Uses</a></p></li>
<li><p><a class="reference internal" href="#configuration-options" id="id8">Configuration Options</a></p></li>
<li><p><a class="reference internal" href="#api-reference" id="id9">API Reference</a></p></li>
</ul>
</div>
<div class="section" id="concepts">
<h2><a class="toc-backref" href="#id1">Concepts</a><a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<p>The kernel can be configured to provide only the floating point services
required by an application. Three modes of operation are supported,
which are described below. In addition, the kernel’s support for the SSE
registers can be included or omitted, as desired.</p>
<div class="section" id="no-fp-registers-mode">
<h3><a class="toc-backref" href="#id2">No FP registers mode</a><a class="headerlink" href="#no-fp-registers-mode" title="Permalink to this headline">¶</a></h3>
<p>This mode is used when the application has no threads that use floating point
registers. It is the kernel’s default floating point services mode.</p>
<p>If a thread uses any floating point register,
the kernel generates a fatal error condition and aborts the thread.</p>
</div>
<div class="section" id="unshared-fp-registers-mode">
<h3><a class="toc-backref" href="#id3">Unshared FP registers mode</a><a class="headerlink" href="#unshared-fp-registers-mode" title="Permalink to this headline">¶</a></h3>
<p>This mode is used when the application has only a single thread
that uses floating point registers.</p>
<p>On x86 platforms, the kernel initializes the floating point registers so they can
be used by any thread (initialization in skipped on ARM Cortex-M platforms and
ARCv2 platforms). The floating point registers are left unchanged whenever a
context switch occurs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The behavior is undefined, if two or more threads attempt to use
the floating point registers, as the kernel does not attempt to detect
(or prevent) multiple threads from using these registers.</p>
</div>
</div>
<div class="section" id="shared-fp-registers-mode">
<h3><a class="toc-backref" href="#id4">Shared FP registers mode</a><a class="headerlink" href="#shared-fp-registers-mode" title="Permalink to this headline">¶</a></h3>
<p>This mode is used when the application has two or more threads that use
floating point registers. Depending upon the underlying CPU architecture,
the kernel supports one or more of the following thread sub-classes:</p>
<ul class="simple">
<li><p>non-user: A thread that cannot use any floating point registers</p></li>
<li><p>FPU user: A thread that can use the standard floating point registers</p></li>
<li><p>SSE user: A thread that can use both the standard floating point registers
and SSE registers</p></li>
</ul>
<p>The kernel initializes and enables access to the floating point registers,
so they can be used
by any thread, then saves and restores these registers during
context switches to ensure the computations performed by each FPU user
or SSE user are not impacted by the computations performed by the other users.</p>
<div class="section" id="arm-cortex-m-architecture-with-the-floating-point-extension">
<h4>ARM Cortex-M architecture (with the Floating Point Extension)<a class="headerlink" href="#arm-cortex-m-architecture-with-the-floating-point-extension" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Shared FP registers mode is the default Floating Point
Services mode in ARM Cortex-M.</p>
</div>
<p>On the ARM Cortex-M architecture with the Floating Point Extension, the kernel
treats <em>all</em> threads as FPU users when shared FP registers mode is enabled.
This means that any thread is allowed to access the floating point registers.
The ARM kernel automatically detects that a given thread is using the floating
point registers the first time the thread accesses them.</p>
<p>Pretag a thread that intends to use the FP registers by
using one of the techniques listed below.</p>
<ul class="simple">
<li><p>A statically-created ARM thread can be pretagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> option to <a class="reference internal" href="../threads/index.html#c.K_THREAD_DEFINE" title="K_THREAD_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_DEFINE</span></code></a>.</p></li>
<li><p>A dynamically-created ARM thread can be pretagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> option to <a class="reference internal" href="../threads/index.html#c.k_thread_create" title="k_thread_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_thread_create()</span></code></a>.</p></li>
</ul>
<p>Pretagging a thread with the <a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> option instructs the
MPU-based stack protection mechanism to properly configure the size of
the thread’s guard region to always guarantee stack overflow detection,
and enable lazy stacking for the given thread upon thread creation.</p>
<p>During thread context switching the ARM kernel saves the <em>callee-saved</em>
floating point registers, if the switched-out thread has been using them.
Additionally, the <em>caller-saved</em> floating point registers are saved on
the thread’s stack. If the switched-in thread has been using the floating
point registers, the kernel restores the <em>callee-saved</em> FP registers of
the switched-in thread and the <em>caller-saved</em> FP context is restored from
the thread’s stack. Thus, the kernel does not save or restore the FP
context of threads that are not using the FP registers.</p>
<p>Each thread that intends to use the floating point registers must provide
an extra 72 bytes of stack space where the callee-saved FP context can
be saved.</p>
<p><a class="reference external" href="https://developer.arm.com/documentation/dai0298/a">Lazy Stacking</a>
is currently enabled in Zephyr applications on ARM Cortex-M
architecture, minimizing interrupt latency, when the floating
point context is active.</p>
<p>When the MPU-based stack protection mechanism is not enabled, lazy stacking
is always active in the Zephyr application. When the MPU-based stack protection
is enabled, the following rules apply with respect to lazy stacking:</p>
<ul class="simple">
<li><p>Lazy stacking is activated by default on threads that are pretagged with
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a></p></li>
<li><p>Lazy stacking is activated dynamically on threads that are not pretagged with
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a>, as soon as the kernel detects that they are using the
floating point registers.</p></li>
</ul>
<p>If an ARM thread does not require use of the floating point registers any
more, it can call <code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_disable()</span></code>. This instructs the kernel
not to save or restore its FP context during thread context switching.</p>
</div>
<div class="section" id="arm64-architecture">
<h4>ARM64 architecture<a class="headerlink" href="#arm64-architecture" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Shared FP registers mode is the default Floating Point
Services mode on ARM64. The compiler is free to optimize code
using FP/SIMD registers, and library functions such as memcpy
are known to make use of them.</p>
</div>
<p>On the ARM64 (Aarch64) architecture the kernel treats each thread as a FPU
user on a case-by-case basis. A “lazy save” algorithm is used during context
switching which updates the floating point registers only when it is absolutely
necessary. For example, the registers are <em>not</em> saved when switching from an
FPU user to a non-user thread, and then back to the original FPU user.</p>
<p>FPU register usage by ISRs is supported although not recommended. When an
ISR uses floating point or SIMD registers, then the access is trapped, the
current FPU user context is saved in the thread object and the ISR is resumed
with interrupts disabled so to prevent another IRQ from interrupting the ISR
and potentially requesting FPU usage. Because ISR don’t have a persistent
register context, there are no provision for saving an ISR’s FPU context
either, hence the IRQ disabling.</p>
<p>Each thread object becomes 512 bytes larger when Shared FP registers mode
is enabled.</p>
</div>
<div class="section" id="arcv2-architecture">
<h4>ARCv2 architecture<a class="headerlink" href="#arcv2-architecture" title="Permalink to this headline">¶</a></h4>
<p>On the ARCv2 architecture, the kernel treats each thread as a non-user
or FPU user and the thread must be tagged by one of the
following techniques.</p>
<ul class="simple">
<li><p>A statically-created ARC thread can be tagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> option to <a class="reference internal" href="../threads/index.html#c.K_THREAD_DEFINE" title="K_THREAD_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_DEFINE</span></code></a>.</p></li>
<li><p>A dynamically-created ARC thread can be tagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> to <a class="reference internal" href="../threads/index.html#c.k_thread_create" title="k_thread_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_thread_create()</span></code></a>.</p></li>
</ul>
<p>If an ARC thread does not require use of the floating point registers any
more, it can call <code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_disable()</span></code>. This instructs the kernel
not to save or restore its FP context during thread context switching.</p>
<p>During thread context switching the ARC kernel saves the <em>callee-saved</em>
floating point registers, if the switched-out thread has been using them.
Additionally, the <em>caller-saved</em> floating point registers are saved on
the thread’s stack. If the switched-in thread has been using the floating
point registers, the kernel restores the <em>callee-saved</em> FP registers of
the switched-in thread and the <em>caller-saved</em> FP context is restored from
the thread’s stack. Thus, the kernel does not save or restore the FP
context of threads that are not using the FP registers. An extra 16 bytes
(single floating point hardware) or 32 bytes (double floating point hardware)
of stack space is required to load and store floating point registers.</p>
</div>
<div class="section" id="risc-v-architecture">
<h4>RISC-V architecture<a class="headerlink" href="#risc-v-architecture" title="Permalink to this headline">¶</a></h4>
<p>On the RISC-V architecture, the kernel treats each thread as a non-user
or FPU user and the thread must be tagged by one of the
following techniques:</p>
<ul class="simple">
<li><p>A statically-created RISC-V thread can be tagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> option to <a class="reference internal" href="../threads/index.html#c.K_THREAD_DEFINE" title="K_THREAD_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_DEFINE</span></code></a>.</p></li>
<li><p>A dynamically-created RISC-V thread can be tagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> to <a class="reference internal" href="../threads/index.html#c.k_thread_create" title="k_thread_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_thread_create()</span></code></a>.</p></li>
<li><p>A running RISC-V thread can be tagged by calling <code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_enable()</span></code>.
This function can only be called from the thread itself.</p></li>
</ul>
<p>If a RISC-V thread no longer requires the use of the floating point registers,
it can call <code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_disable()</span></code>. This instructs the kernel not to
save or restore its FP context during thread context switching. This function
can only be called from the thread itself.</p>
<p>During thread context switching the RISC-V kernel saves the <em>callee-saved</em>
floating point registers, if the switched-out thread is tagged with
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a>. Additionally, the <em>caller-saved</em> floating point
registers are saved on the thread’s stack. If the switched-in thread has been
tagged with <a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a>, then the kernel restores the <em>callee-saved</em>
FP registers of the switched-in thread and the <em>caller-saved</em> FP context is
restored from the thread’s stack. Thus, the kernel does not save or restore the
FP context of threads that are not using the FP registers. An extra 84 bytes
(single floating point hardware) or 164 bytes (double floating point hardware)
of stack space is required to load and store floating point registers.</p>
</div>
<div class="section" id="sparc-architecture">
<h4>SPARC architecture<a class="headerlink" href="#sparc-architecture" title="Permalink to this headline">¶</a></h4>
<p>On the SPARC architecture, the kernel treats each thread as a non-user
or FPU user and the thread must be tagged by one of the
following techniques:</p>
<ul class="simple">
<li><p>A statically-created thread can be tagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> option to <a class="reference internal" href="../threads/index.html#c.K_THREAD_DEFINE" title="K_THREAD_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_DEFINE</span></code></a>.</p></li>
<li><p>A dynamically-created thread can be tagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> to <a class="reference internal" href="../threads/index.html#c.k_thread_create" title="k_thread_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_thread_create()</span></code></a>.</p></li>
</ul>
<p>During thread context switch at exit from interrupt handler, the SPARC
kernel saves <em>all</em> floating point registers, if the FPU was enabled in
the switched-out thread. Floating point registers are saved on the thread’s
stack. Floating point registers are restored when a thread context is restored
iff they were saved at the context save. Saving and restoring of the floating
point registers is synchronous and thus not lazy. The FPU is always disabled
when an ISR is called (independent of <a class="reference internal" href="../../../kconfig.html#CONFIG_FPU_SHARING" title="CONFIG_FPU_SHARING"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_FPU_SHARING</span></code></a>).</p>
<p>Floating point disabling with <code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_disable()</span></code> is not implemented.</p>
<p>When <a class="reference internal" href="../../../kconfig.html#CONFIG_FPU_SHARING" title="CONFIG_FPU_SHARING"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_FPU_SHARING</span></code></a> is used, then 136 bytes of stack space
is required for each FPU user thread to load and store floating point
registers. No extra stack is required if <a class="reference internal" href="../../../kconfig.html#CONFIG_FPU_SHARING" title="CONFIG_FPU_SHARING"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_FPU_SHARING</span></code></a> is
not used.</p>
</div>
<div class="section" id="x86-architecture">
<h4>x86 architecture<a class="headerlink" href="#x86-architecture" title="Permalink to this headline">¶</a></h4>
<p>On the x86 architecture the kernel treats each thread as a non-user,
FPU user or SSE user on a case-by-case basis. A “lazy save” algorithm is used
during context switching which updates the floating point registers only when
it is absolutely necessary. For example, the registers are <em>not</em> saved when
switching from an FPU user to a non-user thread, and then back to the original
FPU user. The following table indicates the amount of additional stack space a
thread must provide so the registers can be saved properly.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 29%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Thread type</p></th>
<th class="head"><p>FP register use</p></th>
<th class="head"><p>Extra stack space required</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>cooperative</p></td>
<td><p>any</p></td>
<td><p>0 bytes</p></td>
</tr>
<tr class="row-odd"><td><p>preemptive</p></td>
<td><p>none</p></td>
<td><p>0 bytes</p></td>
</tr>
<tr class="row-even"><td><p>preemptive</p></td>
<td><p>FPU</p></td>
<td><p>108 bytes</p></td>
</tr>
<tr class="row-odd"><td><p>preemptive</p></td>
<td><p>SSE</p></td>
<td><p>464 bytes</p></td>
</tr>
</tbody>
</table>
<p>The x86 kernel automatically detects that a given thread is using
the floating point registers the first time the thread accesses them.
The thread is tagged as an SSE user if the kernel has been configured
to support the SSE registers, or as an FPU user if the SSE registers are
not supported. If this would result in a thread that is an FPU user being
tagged as an SSE user, or if the application wants to avoid the exception
handling overhead involved in auto-tagging threads, it is possible to
pretag a thread using one of the techniques listed below.</p>
<ul class="simple">
<li><p>A statically-created x86 thread can be pretagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> or <code class="xref c c-macro docutils literal notranslate"><span class="pre">K_SSE_REGS</span></code> option to
<a class="reference internal" href="../threads/index.html#c.K_THREAD_DEFINE" title="K_THREAD_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_DEFINE</span></code></a>.</p></li>
<li><p>A dynamically-created x86 thread can be pretagged by passing the
<a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> or <code class="xref c c-macro docutils literal notranslate"><span class="pre">K_SSE_REGS</span></code> option to
<a class="reference internal" href="../threads/index.html#c.k_thread_create" title="k_thread_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_thread_create()</span></code></a>.</p></li>
<li><p>An already-created x86 thread can pretag itself once it has started
by passing the <a class="reference internal" href="../threads/index.html#c.K_FP_REGS" title="K_FP_REGS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_FP_REGS</span></code></a> or <code class="xref c c-macro docutils literal notranslate"><span class="pre">K_SSE_REGS</span></code> option to
<code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_enable()</span></code>.</p></li>
</ul>
<p>If an x86 thread uses the floating point registers infrequently it can call
<code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_disable()</span></code> to remove its tagging as an FPU user or SSE user.
This eliminates the need for the kernel to take steps to preserve
the contents of the floating point registers during context switches
when there is no need to do so.
When the thread again needs to use the floating point registers it can re-tag
itself as an FPU user or SSE user by calling <code class="xref c c-func docutils literal notranslate"><span class="pre">k_float_enable()</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="implementation">
<h2><a class="toc-backref" href="#id5">Implementation</a><a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="performing-floating-point-arithmetic">
<h3><a class="toc-backref" href="#id6">Performing Floating Point Arithmetic</a><a class="headerlink" href="#performing-floating-point-arithmetic" title="Permalink to this headline">¶</a></h3>
<p>No special coding is required for a thread to use floating point arithmetic
if the kernel is properly configured.</p>
<p>The following code shows how a routine can use floating point arithmetic
to avoid overflow issues when computing the average of a series of integer
values.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">average</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_values</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_values</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="n">values</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">values</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">sum</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">num_values</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="suggested-uses">
<h2><a class="toc-backref" href="#id7">Suggested Uses</a><a class="headerlink" href="#suggested-uses" title="Permalink to this headline">¶</a></h2>
<p>Use the kernel floating point services when an application needs to
perform floating point operations.</p>
</div>
<div class="section" id="configuration-options">
<h2><a class="toc-backref" href="#id8">Configuration Options</a><a class="headerlink" href="#configuration-options" title="Permalink to this headline">¶</a></h2>
<p>To configure unshared FP registers mode, enable the <a class="reference internal" href="../../../kconfig.html#CONFIG_FPU" title="CONFIG_FPU"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_FPU</span></code></a>
configuration option and leave the <a class="reference internal" href="../../../kconfig.html#CONFIG_FPU_SHARING" title="CONFIG_FPU_SHARING"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_FPU_SHARING</span></code></a> configuration
option disabled.</p>
<p>To configure shared FP registers mode, enable both the <a class="reference internal" href="../../../kconfig.html#CONFIG_FPU" title="CONFIG_FPU"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_FPU</span></code></a>
configuration option and the <a class="reference internal" href="../../../kconfig.html#CONFIG_FPU_SHARING" title="CONFIG_FPU_SHARING"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_FPU_SHARING</span></code></a> configuration option.
Also, ensure that any thread that uses the floating point registers has
sufficient added stack space for saving floating point register values
during context switches, as described above.</p>
<p>For x86, use the <a class="reference internal" href="../../../kconfig.html#CONFIG_X86_SSE" title="CONFIG_X86_SSE"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_X86_SSE</span></code></a> configuration option to enable
support for SSEx instructions.</p>
</div>
<div class="section" id="api-reference">
<h2><a class="toc-backref" href="#id9">API Reference</a><a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h2>
<dl>
<dt class="sig sig-object cpp">
<span class="target" id="group__float__apis"></span><em><span class="pre">group</span></em> <span class="sig-name descname"><span class="pre">float_apis</span></span></dt>
<dd></dd></dl>

</div>
</div>


           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../copyright.html">Copyright</a> 2015-2022 Zephyr Project members and individual contributors.
      <span class="lastupdated">Last updated on Mar 05, 2022.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>