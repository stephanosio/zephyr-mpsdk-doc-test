<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resource Management &mdash; Zephyr Project Documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script type="module" src="../../_static/js/dark-mode-toggle.min.mjs"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-831873-47"></script>
        <script src="../../_static/js/ga-tracker.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="Shell" href="../shell/index.html" />
    <link rel="prev" title="Random Number Generation" href="../random/index.html" />
  <meta name="color-scheme" content="dark light">
  
  <link rel="stylesheet" href="../../_static/css/light.css" type="text/css" media="(prefers-color-scheme: light)"/>
  <link rel="stylesheet" href="../../_static/css/dark.css" type="text/css" media="(prefers-color-scheme: dark)"/>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.99
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Document Release Versions</dt>
        
          <dd><a href="/">latest</a></dd>
        
          <dd><a href="/3.0.0/">3.0.0</a></dd>
        
          <dd><a href="/2.7.0/">2.7.0</a></dd>
        
          <dd><a href="/2.6.0/">2.6.0</a></dd>
        
          <dd><a href="/2.5.0/">2.5.0</a></dd>
        
          <dd><a href="/2.4.0/">2.4.0</a></dd>
        
          <dd><a href="/2.3.0/">2.3.0</a></dd>
        
          <dd><a href="/1.14.1/">1.14.1</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
        <dd><a href="/latest/zephyr.pdf">PDF</a></dd>
      </dl>
      <dl>
        <dt>zephyrproject.org Links</dt>
          <dd>
            <a href="https://www.zephyrproject.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/sdk-ng/releases">SDK</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/zephyr/releases">Releases</a>
          </dd>
      </dl>
    </div>
  </div>
  
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/build/index.html">Build and Configuration Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/index.html">Application Development</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Status and Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio/index.html">Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/notify.html">Asynchronous Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/index.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../canbus/index.html">Controller Area Network (CAN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto/index.html">Crypto</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devicetree/index.html">Devicetree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../drivers/index.html">Device Driver Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../display/index.html">Display Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac/index.html">Error Detection And Correction (EDAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file_system/index.html">File Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iterable_sections/index.html">Iterable Sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/formatted_output.html">Formatted Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/index.html">Kernel Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libc/index.html">C standard library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_management/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/index.html">Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_structures/index.html">Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modbus/index.html">Modbus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peripherals/index.html">Peripherals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pinctrl/index.html">Pin Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../random/index.html">Random Number Generation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Resource Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#on-off-manager">On-Off Manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../shell/index.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../task_wdt/index.html">Task Watchdog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/timeutil.html">Time Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/index.html">USB device support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usermode/index.html">User Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../util/index.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../settings/index.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timing_functions/index.html">Executing Time Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../virtualization/index.html">Virtualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/index.html">User and Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Release Notes</a></li>
</ul>

  
  <div class="toctree-wrapper compound">
    <p class="caption"><span class="caption-text">Reference</span></p>
    <ul>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/doxygen/html/index.html">API</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/kconfig.html">Kconfig Options</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/devicetree/bindings.html">Devicetree Bindings</a>
      </li>
      
    </ul>
  </div>
  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zephyr Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <!-- Docs / Latest -->
  
  

  <li><a href="../../index.html">Docs / Latest</a> &raquo;</li>
  
     <li><a href="../index.html">API Reference</a> &raquo;</li>
  
  <li>Resource Management</li>


  <li class="wy-breadcrumbs-aside">
    <dark-mode-toggle id="dark-mode-toggle" appearance="toggle" permanent="true"/>
  </li>
  <li class="wy-breadcrumbs-aside">
      
      
        <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/doc/reference/resource_management/index.rst" class="fa fa-github"> Open on GitHub</a>
      
    
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
    <div class="wy-alert wy-alert-danger">
     This is the documentation for the latest (main) development branch of
     Zephyr. If you are looking for the documentation of previous releases, use
     the drop-down menu on the left and select the desired version.
    </div>
  
  
           <div itemprop="articleBody">
             
  <div class="section" id="resource-management">
<span id="resource-mgmt"></span><h1>Resource Management<a class="headerlink" href="#resource-management" title="Permalink to this headline">¶</a></h1>
<p>There are various situations where it’s necessary to coordinate resource
use at runtime among multiple clients.  These include power rails,
clocks, other peripherals, and binary device power management. The
complexity of properly managing multiple consumers of a device in a
multithreaded system, especially when transitions may be asynchronous,
suggests that a shared implementation is desirable.</p>
<p>Zephyr provides managers for several coordination policies.  These
managers are embedded into services that use them for specific
functions.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#on-off-manager" id="id1">On-Off Manager</a></p></li>
</ul>
</div>
<div class="section" id="on-off-manager">
<span id="resource-mgmt-onoff"></span><h2><a class="toc-backref" href="#id1">On-Off Manager</a><a class="headerlink" href="#on-off-manager" title="Permalink to this headline">¶</a></h2>
<p>An on-off manager supports an arbitrary number of clients of a service
which has a binary state.  Example applications are power rails, clocks,
and binary device power management.</p>
<p>The manager has the following properties:</p>
<ul class="simple">
<li><p>The stable states are off, on, and error.  The service always begins
in the off state.  The service may also be in a transition to a given
state.</p></li>
<li><p>The core operations are request (add a dependency) and release (remove
a dependency). Supporting operations are reset (to clear an error
state) and cancel (to reclaim client data from an in-progress
transition).  The service manages the state based on calls to
functions that initiate these operations.</p></li>
<li><p>The service transitions from off to on when first client request is
received.</p></li>
<li><p>The service transitions from on to off when last client release is
received.</p></li>
<li><p>Each service configuration provides functions that implement the
transition from off to on, from on to off, and optionally from an
error state to off.  Transitions must be invokable from both thread
and interrupt context.</p></li>
<li><p>The request and reset operations are asynchronous using
<a class="reference internal" href="../misc/notify.html#async-notification"><span class="std std-ref">Asynchronous Notifications</span></a>.  Both operations may be cancelled, but
cancellation has no effect on the in-progress transition.</p></li>
<li><p>Requests to turn on may be queued while a transition to off is in
progress: when the service has turned off successfully it will be
immediately turned on again (where context allows) and waiting clients
notified when the start completes.</p></li>
</ul>
<p>Requests are reference counted, but not tracked. That means clients are
responsible for recording whether their requests were accepted, and for
initiating a release only if they have previously successfully completed
a request.  Improper use of the API can cause an active client to be
shut out, and the manager does not maintain a record of specific clients
that have been granted a request.</p>
<p>Failures in executing a transition are recorded and inhibit further
requests or releases until the manager is reset. Pending requests are
notified (and cancelled) when errors are discovered.</p>
<p>Transition operation completion notifications are provided through
<a class="reference internal" href="../misc/notify.html#async-notification"><span class="std std-ref">Asynchronous Notifications</span></a>.</p>
<p>Clients and other components interested in tracking all service state
changes, including when a service begins turning off or enters an error
state, can be informed of state transitions by registering a monitor
with onoff_monitor_register().  Notification of changes are provided
before issuing completion notifications associated with the new
state.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A generic API may be implemented by multiple drivers where the common
case is asynchronous.  The on-off client structure may be an
appropriate solution for the generic API.  Where drivers that can
guarantee synchronous context-independent transitions a driver may
use <a class="reference internal" href="#c.onoff_sync_service" title="onoff_sync_service"><code class="xref c c-type docutils literal notranslate"><span class="pre">onoff_sync_service</span></code></a> and its supporting API rather than
<a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><code class="xref c c-type docutils literal notranslate"><span class="pre">onoff_manager</span></code></a>, with only a small reduction in functionality
(primarily no support for the monitor API).</p>
</div>
<dl>
<dt class="sig sig-object cpp">
<span class="target" id="group__resource__mgmt__onoff__apis"></span><em><span class="pre">group</span></em> <span class="sig-name descname"><span class="pre">resource_mgmt_onoff_apis</span></span></dt>
<dd><div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-defines">Defines</p>
<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_FLAG_ERROR">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga9ae0c3528254b10f5e1a9743aea234dd"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_FLAG_ERROR</span></span></span><a class="headerlink" href="#c.ONOFF_FLAG_ERROR" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Flag indicating an error state. </p>
<p>Error states are cleared using <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gaf7b46a5f2e43d1bab193c18b8f6c8ba8"><span class="std std-ref">onoff_reset()</span></a>. </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_FLAG_ONOFF">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga7189c7d7b3180c4e12a16b96ac52b15d"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_FLAG_ONOFF</span></span></span><a class="headerlink" href="#c.ONOFF_FLAG_ONOFF" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_FLAG_TRANSITION">
<span class="target" id="group__resource__mgmt__onoff__apis_1gabfee74d3339efe10acc40603c73954bb"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_FLAG_TRANSITION</span></span></span><a class="headerlink" href="#c.ONOFF_FLAG_TRANSITION" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_STATE_MASK">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga0e06eafdf5021ce970027f20fc001acc"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_STATE_MASK</span></span></span><a class="headerlink" href="#c.ONOFF_STATE_MASK" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Mask used to isolate bits defining the service state. </p>
<p>Mask a value with this then test for ONOFF_FLAG_ERROR to determine whether the machine has an unfixed error, or compare against ONOFF_STATE_ON, ONOFF_STATE_OFF, ONOFF_STATE_TO_ON, ONOFF_STATE_TO_OFF, or ONOFF_STATE_RESETTING. </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_STATE_OFF">
<span class="target" id="group__resource__mgmt__onoff__apis_1gab9e5380dce026a5dfea770f999400484"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_STATE_OFF</span></span></span><a class="headerlink" href="#c.ONOFF_STATE_OFF" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Value exposed by ONOFF_STATE_MASK when service is off. </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_STATE_ON">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga7cd0fba52afba2e337ab7c830d3058d7"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_STATE_ON</span></span></span><a class="headerlink" href="#c.ONOFF_STATE_ON" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Value exposed by ONOFF_STATE_MASK when service is on. </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_STATE_ERROR">
<span class="target" id="group__resource__mgmt__onoff__apis_1gac005a25d149568208a6fbaa2ceaa1ac6"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_STATE_ERROR</span></span></span><a class="headerlink" href="#c.ONOFF_STATE_ERROR" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Value exposed by ONOFF_STATE_MASK when the service is in an error state (and not in the process of resetting its state). </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_STATE_TO_ON">
<span class="target" id="group__resource__mgmt__onoff__apis_1gac4a0d8a7b501adb011aa1c4c4da3f2a3"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_STATE_TO_ON</span></span></span><a class="headerlink" href="#c.ONOFF_STATE_TO_ON" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Value exposed by ONOFF_STATE_MASK when service is transitioning to on. </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_STATE_TO_OFF">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga235a04122763f1a2cbb849c56df65d26"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_STATE_TO_OFF</span></span></span><a class="headerlink" href="#c.ONOFF_STATE_TO_OFF" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Value exposed by ONOFF_STATE_MASK when service is transitioning to off. </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_STATE_RESETTING">
<span class="target" id="group__resource__mgmt__onoff__apis_1gacc0438b5c81c639e0035ada5caec940b"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_STATE_RESETTING</span></span></span><a class="headerlink" href="#c.ONOFF_STATE_RESETTING" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Value exposed by ONOFF_STATE_MASK when service is in the process of resetting. </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_TRANSITIONS_INITIALIZER">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga8c1171a844ef1d9d6541d342124492ff"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_TRANSITIONS_INITIALIZER</span></span></span><span class="sig-paren">(</span><span class="n"><span class="pre">_start</span></span>, <span class="n"><span class="pre">_stop</span></span>, <span class="n"><span class="pre">_reset</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.ONOFF_TRANSITIONS_INITIALIZER" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Initializer for a <a class="reference internal" href="#structonoff__transitions"><span class="std std-ref">onoff_transitions</span></a> object. </p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>_start</strong> – a function used to transition from off to on state.</p></li>
<li><p><strong>_stop</strong> – a function used to transition from on to off state.</p></li>
<li><p><strong>_reset</strong> – a function used to clear errors and force the service to an off state. Can be null. </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_MANAGER_INITIALIZER">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga7ce4af635f16ad39097502a68dc125e7"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_MANAGER_INITIALIZER</span></span></span><span class="sig-paren">(</span><span class="n"><span class="pre">_transitions</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.ONOFF_MANAGER_INITIALIZER" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.ONOFF_CLIENT_EXTENSION_POS">
<span class="target" id="group__resource__mgmt__onoff__apis_1gad61d053ae4e9ee12efe8d37372a16c63"></span><span class="sig-name descname"><span class="n"><span class="pre">ONOFF_CLIENT_EXTENSION_POS</span></span></span><a class="headerlink" href="#c.ONOFF_CLIENT_EXTENSION_POS" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Identify region of <a class="reference internal" href="../misc/notify.html#structsys__notify"><span class="std std-ref">sys_notify</span></a> flags available for containing services. </p>
<p>Bits of the flags field of the <a class="reference internal" href="../misc/notify.html#structsys__notify"><span class="std std-ref">sys_notify</span></a> structure contained within the queued_operation structure at and above this position may be used by extensions to the <a class="reference internal" href="#structonoff__client"><span class="std std-ref">onoff_client</span></a> structure.</p>
<p>These bits are intended for use by containing service implementations to record client-specific information and are subject to other conditions of use specified on the <a class="reference internal" href="../misc/notify.html#structsys__notify"><span class="std std-ref">sys_notify</span></a> API. </p>
</dd></dl>

</div>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-typedefs">Typedefs</p>
<dl class="c type">
<dt class="sig sig-object c" id="c.onoff_notify_fn">
<span class="target" id="group__resource__mgmt__onoff__apis_1gac05f7946a14fa23ef67212eba30c98ac"></span><span class="k"><span class="pre">typedef</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">(</span></span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">onoff_notify_fn</span></span></span><span class="p"><span class="pre">)</span></span><span class="p"><span class="pre">(</span></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">res</span></span><span class="p"><span class="pre">)</span></span><a class="headerlink" href="#c.onoff_notify_fn" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Signature used to notify an on-off manager that a transition has completed. </p>
<p>Functions of this type are passed to service-specific transition functions to be used to report the completion of the operation. The functions may be invoked from any context.</p>
<dl class="field-list simple">
<dt class="field-odd">Param mgr</dt>
<dd class="field-odd"><p>the manager for which transition was requested.</p>
</dd>
<dt class="field-even">Param res</dt>
<dd class="field-even"><p>the result of the transition. This shall be non-negative on success, or a negative error code. If an error is indicated the service shall enter an error state. </p>
</dd>
</dl>
</dd></dl>

<dl class="c type">
<dt class="sig sig-object c" id="c.onoff_transition_fn">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga51fdf83642c5fa16112ce143382ec5d1"></span><span class="k"><span class="pre">typedef</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">(</span></span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">onoff_transition_fn</span></span></span><span class="p"><span class="pre">)</span></span><span class="p"><span class="pre">(</span></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_notify_fn" title="onoff_notify_fn"><span class="n"><span class="pre">onoff_notify_fn</span></span></a><span class="w"> </span><span class="n"><span class="pre">notify</span></span><span class="p"><span class="pre">)</span></span><a class="headerlink" href="#c.onoff_transition_fn" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Signature used by service implementations to effect a transition. </p>
<p>Service definitions use two required function pointers of this type to be notified that a transition is required, and a third optional one to reset the service when it is in an error state.</p>
<p>The start function will be called only from the off state.</p>
<p>The stop function will be called only from the on state.</p>
<p>The reset function (where supported) will be called only when <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga347efda0aa0305c134224c59677fa6cb"><span class="std std-ref">onoff_has_error()</span></a> returns true.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All transitions functions must be isr-ok.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Param mgr</dt>
<dd class="field-odd"><p>the manager for which transition was requested.</p>
</dd>
<dt class="field-even">Param notify</dt>
<dd class="field-even"><p>the function to be invoked when the transition has completed. If the transition is synchronous, notify shall be invoked by the implementation before the transition function returns. Otherwise the implementation shall capture this parameter and invoke it when the transition completes. </p>
</dd>
</dl>
</dd></dl>

<dl class="c type">
<dt class="sig sig-object c" id="c.onoff_client_callback">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga41b94526182c5772d7adebb1d1745068"></span><span class="k"><span class="pre">typedef</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">(</span></span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">onoff_client_callback</span></span></span><span class="p"><span class="pre">)</span></span><span class="p"><span class="pre">(</span></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_client" title="onoff_client"><span class="n"><span class="pre">onoff_client</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">cli</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="n"><span class="pre">uint32_t</span></span><span class="w"> </span><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">res</span></span><span class="p"><span class="pre">)</span></span><a class="headerlink" href="#c.onoff_client_callback" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Signature used to notify an on-off service client of the completion of an operation. </p>
<p>These functions may be invoked from any context including pre-kernel, ISR, or cooperative or pre-emptible threads. Compatible functions must be isr-ok and not sleep.</p>
<dl class="field-list simple">
<dt class="field-odd">Param mgr</dt>
<dd class="field-odd"><p>the manager for which the operation was initiated. This may be null if the on-off service uses synchronous transitions.</p>
</dd>
<dt class="field-even">Param cli</dt>
<dd class="field-even"><p>the client structure passed to the function that initiated the operation.</p>
</dd>
<dt class="field-odd">Param state</dt>
<dd class="field-odd"><p>the state of the machine at the time of completion, restricted by ONOFF_STATE_MASK. ONOFF_FLAG_ERROR must be checked independently of whether res is negative as a machine error may indicate that all future operations except <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gaf7b46a5f2e43d1bab193c18b8f6c8ba8"><span class="std std-ref">onoff_reset()</span></a> will fail.</p>
</dd>
<dt class="field-even">Param res</dt>
<dd class="field-even"><p>the result of the operation. Expected values are service-specific, but the value shall be non-negative if the operation succeeded, and negative if the operation failed. If res is negative ONOFF_FLAG_ERROR will be set in state, but if res is non-negative ONOFF_FLAG_ERROR may still be set in state. </p>
</dd>
</dl>
</dd></dl>

<dl class="c type">
<dt class="sig sig-object c" id="c.onoff_monitor_callback">
<span class="target" id="group__resource__mgmt__onoff__apis_1gaee41b38d408cf5f5efc9cd007f377545"></span><span class="k"><span class="pre">typedef</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">(</span></span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">onoff_monitor_callback</span></span></span><span class="p"><span class="pre">)</span></span><span class="p"><span class="pre">(</span></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_monitor" title="onoff_monitor"><span class="n"><span class="pre">onoff_monitor</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mon</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="n"><span class="pre">uint32_t</span></span><span class="w"> </span><span class="n"><span class="pre">state</span></span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">res</span></span><span class="p"><span class="pre">)</span></span><a class="headerlink" href="#c.onoff_monitor_callback" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Signature used to notify a monitor of an onoff service of errors or completion of a state transition. </p>
<p>This is similar to onoff_client_callback but provides information about all transitions, not just ones associated with a specific client. Monitor callbacks are invoked before any completion notifications associated with the state change are made.</p>
<p>These functions may be invoked from any context including pre-kernel, ISR, or cooperative or pre-emptible threads. Compatible functions must be isr-ok and not sleep.</p>
<p>The callback is permitted to unregister itself from the manager, but must not register or unregister any other monitors.</p>
<dl class="field-list simple">
<dt class="field-odd">Param mgr</dt>
<dd class="field-odd"><p>the manager for which a transition has completed.</p>
</dd>
<dt class="field-even">Param mon</dt>
<dd class="field-even"><p>the monitor instance through which this notification arrived.</p>
</dd>
<dt class="field-odd">Param state</dt>
<dd class="field-odd"><p>the state of the machine at the time of completion, restricted by ONOFF_STATE_MASK. All valid states may be observed.</p>
</dd>
<dt class="field-even">Param res</dt>
<dd class="field-even"><p>the result of the operation. Expected values are service- and state-specific, but the value shall be non-negative if the operation succeeded, and negative if the operation failed. </p>
</dd>
</dl>
</dd></dl>

</div>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-functions">Functions</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_manager_init">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga73d52272baab03d1df2f267429390978"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_manager_init</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_transitions" title="onoff_transitions"><span class="n"><span class="pre">onoff_transitions</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">transitions</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_manager_init" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Initialize an on-off service to off state. </p>
<p>This function must be invoked exactly once per service instance, by the infrastructure that provides the service, and before any other on-off service API is invoked on the service.</p>
<p>This function should never be invoked by clients of an on-off service.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager definition object to be initialized.</p></li>
<li><p><strong>transitions</strong> – pointer to a structure providing transition functions. The referenced object must persist as long as the manager can be referenced.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>0</strong> – on success </p></li>
<li><p><strong>-EINVAL</strong> – if start, stop, or flags are invalid </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_has_error">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga347efda0aa0305c134224c59677fa6cb"></span><span class="k"><span class="pre">static</span></span><span class="w"> </span><span class="k"><span class="pre">inline</span></span><span class="w"> </span><span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_has_error</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_has_error" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Test whether an on-off service has recorded an error. </p>
<p>This function can be used to determine whether the service has recorded an error. Errors may be cleared by invoking <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gaf7b46a5f2e43d1bab193c18b8f6c8ba8"><span class="std std-ref">onoff_reset()</span></a>.</p>
<p>This is an unlocked convenience function suitable for use only when it is known that no other process might invoke an operation that transitions the service between an error and non-error state.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>true if and only if the service has an uncleared error. </p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_request">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga20dcb358e405deb87b7fbb7846ef9d68"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_request</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_client" title="onoff_client"><span class="n"><span class="pre">onoff_client</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">cli</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_request" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Request a reservation to use an on-off service. </p>
<p>The return value indicates the success or failure of an attempt to initiate an operation to request the resource be made available. If initiation of the operation succeeds the result of the request operation is provided through the configured client notification method, possibly before this call returns.</p>
<p>Note that the call to this function may succeed in a case where the actual request fails. Always check the operation completion result.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager that will be used.</p></li>
<li><p><strong>cli</strong> – a non-null pointer to client state providing instructions on synchronous expectations and how to notify the client when the request completes. Behavior is undefined if client passes a pointer object associated with an incomplete service operation.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>non-negative</strong> – the observed state of the machine at the time the request was processed, if successful. </p></li>
<li><p><strong>-EIO</strong> – if service has recorded an an error. </p></li>
<li><p><strong>-EINVAL</strong> – if the parameters are invalid. </p></li>
<li><p><strong>-EAGAIN</strong> – if the reference count would overflow. </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_release">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga19da5359f10fa2e2eb034d1e72235ea6"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_release</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_release" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Release a reserved use of an on-off service. </p>
<p>This synchronously releases the caller’s previous request. If the last request is released the manager will initiate a transition to off, which can be observed by registering an <a class="reference internal" href="#structonoff__monitor"><span class="std std-ref">onoff_monitor</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Behavior is undefined if this is not paired with a preceding <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga20dcb358e405deb87b7fbb7846ef9d68"><span class="std std-ref">onoff_request()</span></a> call that completed successfully.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager for which a request was successful.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>non-negative</strong> – the observed state (ONOFF_STATE_ON) of the machine at the time of the release, if the release succeeds. </p></li>
<li><p><strong>-EIO</strong> – if service has recorded an an error. </p></li>
<li><p><strong>-ENOTSUP</strong> – if the machine is not in a state that permits release. </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_cancel">
<span class="target" id="group__resource__mgmt__onoff__apis_1gad05d32f1548e56b508628e84ba101554"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_cancel</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_client" title="onoff_client"><span class="n"><span class="pre">onoff_client</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">cli</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_cancel" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Attempt to cancel an in-progress client operation. </p>
<p>It may be that a client has initiated an operation but needs to shut down before the operation has completed. For example, when a request was made and the need is no longer present.</p>
<p>Cancelling is supported only for <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga20dcb358e405deb87b7fbb7846ef9d68"><span class="std std-ref">onoff_request()</span></a> and <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gaf7b46a5f2e43d1bab193c18b8f6c8ba8"><span class="std std-ref">onoff_reset()</span></a> operations, and is a synchronous operation. Be aware that any transition that was initiated on behalf of the client will continue to progress to completion: it is only notification of transition completion that may be eliminated. If there are no active requests when a transition to on completes the manager will initiate a transition to off.</p>
<p>Client notification does not occur for cancelled operations.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager for which an operation is to be cancelled.</p></li>
<li><p><strong>cli</strong> – a pointer to the same client state that was provided when the operation to be cancelled was issued.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>non-negative</strong> – the observed state of the machine at the time of the cancellation, if the cancellation succeeds. On successful cancellation ownership of <code class="docutils literal notranslate"><span class="pre">*cli</span></code> reverts to the client. </p></li>
<li><p><strong>-EINVAL</strong> – if the parameters are invalid. </p></li>
<li><p><strong>-EALREADY</strong> – if cli was not a record of an uncompleted notification at the time the cancellation was processed. This likely indicates that the operation and client notification had already completed. </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_cancel_or_release">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga7aac2aeb66907ec920557f0ef67d6795"></span><span class="k"><span class="pre">static</span></span><span class="w"> </span><span class="k"><span class="pre">inline</span></span><span class="w"> </span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_cancel_or_release</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_client" title="onoff_client"><span class="n"><span class="pre">onoff_client</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">cli</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_cancel_or_release" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Helper function to safely cancel a request. </p>
<p>Some applications may want to issue requests on an asynchronous event (such as connection to a USB bus) and to release on a paired event (such as loss of connection to a USB bus). Applications cannot precisely determine that an in-progress request is still pending without using <a class="reference internal" href="#structonoff__monitor"><span class="std std-ref">onoff_monitor</span></a> and carefully avoiding race conditions.</p>
<p>This function is a helper that attempts to cancel the operation and issues a release if cancellation fails because the request was completed. This synchronously ensures that ownership of the client data reverts to the client so is available for a future request.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager for which an operation is to be cancelled.</p></li>
<li><p><strong>cli</strong> – a pointer to the same client state that was provided when <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga20dcb358e405deb87b7fbb7846ef9d68"><span class="std std-ref">onoff_request()</span></a> was invoked. Behavior is undefined if this is a pointer to client data associated with an <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gaf7b46a5f2e43d1bab193c18b8f6c8ba8"><span class="std std-ref">onoff_reset()</span></a> request.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>ONOFF_STATE_TO_ON</strong> – if the cancellation occurred before the transition completed.</p></li>
<li><p><strong>ONOFF_STATE_ON</strong> – if the cancellation occurred after the transition completed.</p></li>
<li><p><strong>-EINVAL</strong> – if the parameters are invalid.</p></li>
<li><p><strong>negative</strong> – other errors produced by <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga19da5359f10fa2e2eb034d1e72235ea6"><span class="std std-ref">onoff_release()</span></a>. </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_reset">
<span class="target" id="group__resource__mgmt__onoff__apis_1gaf7b46a5f2e43d1bab193c18b8f6c8ba8"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_reset</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_client" title="onoff_client"><span class="n"><span class="pre">onoff_client</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">cli</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_reset" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Clear errors on an on-off service and reset it to its off state. </p>
<p>A service can only be reset when it is in an error state as indicated by <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga347efda0aa0305c134224c59677fa6cb"><span class="std std-ref">onoff_has_error()</span></a>.</p>
<p>The return value indicates the success or failure of an attempt to initiate an operation to reset the resource. If initiation of the operation succeeds the result of the reset operation itself is provided through the configured client notification method, possibly before this call returns. Multiple clients may request a reset; all are notified when it is complete.</p>
<p>Note that the call to this function may succeed in a case where the actual reset fails. Always check the operation completion result.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Due to the conditions on state transition all incomplete asynchronous operations will have been informed of the error when it occurred. There need be no concern about dangling requests left after a reset completes.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager to be reset.</p></li>
<li><p><strong>cli</strong> – pointer to client state, including instructions on how to notify the client when reset completes. Behavior is undefined if cli references an object associated with an incomplete service operation.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>non-negative</strong> – the observed state of the machine at the time of the reset, if the reset succeeds. </p></li>
<li><p><strong>-ENOTSUP</strong> – if reset is not supported by the service. </p></li>
<li><p><strong>-EINVAL</strong> – if the parameters are invalid. </p></li>
<li><p><strong>-EALREADY</strong> – if the service does not have a recorded error. </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_monitor_register">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga9897d93359fe58359c0204da46b4c01e"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_monitor_register</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_monitor" title="onoff_monitor"><span class="n"><span class="pre">onoff_monitor</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mon</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_monitor_register" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Add a monitor of state changes for a manager. </p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager for which a state changes are to be monitored.</p></li>
<li><p><strong>mon</strong> – a linkable node providing a non-null callback to be invoked on state changes.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>non-negative on successful addition, or a negative error code. </p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_monitor_unregister">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga50a51da8e701a3f19f242af5183d807a"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_monitor_unregister</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_manager" title="onoff_manager"><span class="n"><span class="pre">onoff_manager</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mgr</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_monitor" title="onoff_monitor"><span class="n"><span class="pre">onoff_monitor</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">mon</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_monitor_unregister" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Remove a monitor of state changes from a manager. </p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mgr</strong> – the manager for which a state changes are to be monitored.</p></li>
<li><p><strong>mon</strong> – a linkable node providing the callback to be invoked on state changes.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>non-negative on successful removal, or a negative error code. </p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_sync_lock">
<span class="target" id="group__resource__mgmt__onoff__apis_1ga174cadf7dfa5d3c4dc5c8185994f3825"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_sync_lock</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_sync_service" title="onoff_sync_service"><span class="n"><span class="pre">onoff_sync_service</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">srv</span></span>, <a class="reference internal" href="../kernel/smp/smp.html#c.k_spinlock_key_t" title="k_spinlock_key_t"><span class="n"><span class="pre">k_spinlock_key_t</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">keyp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_sync_lock" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Lock a synchronous onoff service and provide its state. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If an error state is returned it is the caller’s responsibility to decide whether to preserve it (finalize with the same error state) or clear the error (finalize with a non-error result).</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>srv</strong> – pointer to the synchronous service state.</p></li>
<li><p><strong>keyp</strong> – pointer to where the lock key should be stored</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>negative if the service is in an error state, otherwise the number of active requests at the time the lock was taken. The lock is held on return regardless of whether a negative state is returned. </p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.onoff_sync_finalize">
<span class="target" id="group__resource__mgmt__onoff__apis_1gae3331bdad9d03309ee78e86c487b7f26"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_sync_finalize</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_sync_service" title="onoff_sync_service"><span class="n"><span class="pre">onoff_sync_service</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">srv</span></span>, <a class="reference internal" href="../kernel/smp/smp.html#c.k_spinlock_key_t" title="k_spinlock_key_t"><span class="n"><span class="pre">k_spinlock_key_t</span></span></a><span class="w"> </span><span class="n"><span class="pre">key</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.onoff_client" title="onoff_client"><span class="n"><span class="pre">onoff_client</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">cli</span></span>, <span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">res</span></span>, <span class="kt"><span class="pre">bool</span></span><span class="w"> </span><span class="n"><span class="pre">on</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.onoff_sync_finalize" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Process the completion of a transition in a synchronous service and release lock. </p>
<p>This function updates the service state on the <code class="docutils literal notranslate"><span class="pre">res</span></code> and <code class="docutils literal notranslate"><span class="pre">on</span></code> parameters then releases the lock. If <code class="docutils literal notranslate"><span class="pre">cli</span></code> is not null it finalizes the client notification using <code class="docutils literal notranslate"><span class="pre">res</span></code>.</p>
<p>If the service was in an error state when locked, and <code class="docutils literal notranslate"><span class="pre">res</span></code> is non-negative when finalized, the count is reset to zero before completing finalization.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>srv</strong> – pointer to the synchronous service state</p></li>
<li><p><strong>key</strong> – the key returned by the preceding invocation of <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga174cadf7dfa5d3c4dc5c8185994f3825"><span class="std std-ref">onoff_sync_lock()</span></a>.</p></li>
<li><p><strong>cli</strong> – pointer to the onoff client through which completion information is returned. If a null pointer is passed only the state of the service is updated. For compatibility with the behavior of callbacks used with the manager API <code class="docutils literal notranslate"><span class="pre">cli</span></code> must be null when <code class="docutils literal notranslate"><span class="pre">on</span></code> is false (the manager does not support callbacks when turning off devices).</p></li>
<li><p><strong>res</strong> – the result of the transition. A negative value places the service into an error state. A non-negative value increments or decrements the reference count as specified by <code class="docutils literal notranslate"><span class="pre">on</span></code>.</p></li>
<li><p><strong>on</strong> – Only when <code class="docutils literal notranslate"><span class="pre">res</span></code> is non-negative, the service reference count will be incremented if<code class="docutils literal notranslate"><span class="pre">on</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, and decremented if <code class="docutils literal notranslate"><span class="pre">on</span></code> is <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>negative if the service is left or put into an error state, otherwise the number of active requests at the time the lock was released. </p>
</dd>
</dl>
</dd></dl>

</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.onoff_transitions">
<span class="target" id="structonoff__transitions"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_transitions</span></span></span><a class="headerlink" href="#c.onoff_transitions" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;onoff.h&gt;</em></div>
<p>On-off service transition functions. </p>
</dd></dl>

<dl class="c struct">
<dt class="sig sig-object c" id="c.onoff_manager">
<span class="target" id="structonoff__manager"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_manager</span></span></span><a class="headerlink" href="#c.onoff_manager" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;onoff.h&gt;</em></div>
<p>State associated with an on-off manager. </p>
<p>No fields in this structure are intended for use by service providers or clients. The state is to be initialized once, using <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga73d52272baab03d1df2f267429390978"><span class="std std-ref">onoff_manager_init()</span></a>, when the service provider is initialized. In case of error it may be reset through the <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gaf7b46a5f2e43d1bab193c18b8f6c8ba8"><span class="std std-ref">onoff_reset()</span></a> API. </p>
</dd></dl>

<dl class="c struct">
<dt class="sig sig-object c" id="c.onoff_client">
<span class="target" id="structonoff__client"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_client</span></span></span><a class="headerlink" href="#c.onoff_client" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;onoff.h&gt;</em></div>
<p>State associated with a client of an on-off service. </p>
<p>Objects of this type are allocated by a client, which is responsible for zero-initializing the node field and invoking the approprite <a class="reference internal" href="../misc/notify.html#structsys__notify"><span class="std std-ref">sys_notify</span></a> init function to configure notification.</p>
<p>Control of the object content transfers to the service provider when a pointer to the object is passed to any on-off manager function. While the service provider controls the object the client must not change any object fields. Control reverts to the client concurrent with release of the owned <a class="reference internal" href="../misc/notify.html#structsys__notify"><span class="std std-ref">sys_notify</span></a> structure, or when indicated by an <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gad05d32f1548e56b508628e84ba101554"><span class="std std-ref">onoff_cancel()</span></a> return value.</p>
<p>After control has reverted to the client the notify field must be reinitialized for the next operation. </p>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-public-members">Public Members</p>
<dl class="c var">
<dt class="sig sig-object c" id="c.onoff_client.notify">
<span class="target" id="structonoff__client_1a40f8029732122f7887bb021de362742c"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../misc/notify.html#c.sys_notify" title="sys_notify"><span class="n"><span class="pre">sys_notify</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">notify</span></span></span><a class="headerlink" href="#c.onoff_client.notify" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Notification configuration. </p>
</dd></dl>

</div>
</dd></dl>

<dl class="c struct">
<dt class="sig sig-object c" id="c.onoff_monitor">
<span class="target" id="structonoff__monitor"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_monitor</span></span></span><a class="headerlink" href="#c.onoff_monitor" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;onoff.h&gt;</em></div>
<p>Registration state for notifications of onoff service transitions. </p>
<p>Any given <a class="reference internal" href="#structonoff__monitor"><span class="std std-ref">onoff_monitor</span></a> structure can be associated with at most one <a class="reference internal" href="#structonoff__manager"><span class="std std-ref">onoff_manager</span></a> instance. </p>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-public-members">Public Members</p>
<dl class="c var">
<dt class="sig sig-object c" id="c.onoff_monitor.callback">
<span class="target" id="structonoff__monitor_1ab26d8ae8a0dac5e03549e2d9aca243a4"></span><a class="reference internal" href="#c.onoff_monitor_callback" title="onoff_monitor_callback"><span class="n"><span class="pre">onoff_monitor_callback</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">callback</span></span></span><a class="headerlink" href="#c.onoff_monitor.callback" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Callback to be invoked on state change. </p>
<p>This must not be null. </p>
</dd></dl>

</div>
</dd></dl>

<dl class="c struct">
<dt class="sig sig-object c" id="c.onoff_sync_service">
<span class="target" id="structonoff__sync__service"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">onoff_sync_service</span></span></span><a class="headerlink" href="#c.onoff_sync_service" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;onoff.h&gt;</em></div>
<p>State used when a driver uses the on-off service API for synchronous operations. </p>
<p>This is useful when a subsystem API uses the on-off API to support asynchronous operations but the transitions required by a particular driver are isr-ok and not sleep. It serves as a substitute for <a class="reference internal" href="#structonoff__manager"><span class="std std-ref">onoff_manager</span></a>, with locking and persisted state updates supported by <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1ga174cadf7dfa5d3c4dc5c8185994f3825"><span class="std std-ref">onoff_sync_lock()</span></a> and <a class="reference internal" href="#group__resource__mgmt__onoff__apis_1gae3331bdad9d03309ee78e86c487b7f26"><span class="std std-ref">onoff_sync_finalize()</span></a>. </p>
</dd></dl>

</dd></dl>

</div>
</div>


           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2015-2022 Zephyr Project members and individual contributors.
      <span class="lastupdated">Last updated on Mar 05, 2022.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>