<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kernel Objects &mdash; Zephyr Project Documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script type="module" src="../../_static/js/dark-mode-toggle.min.mjs"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-831873-47"></script>
        <script src="../../_static/js/ga-tracker.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="System Calls" href="syscalls.html" />
    <link rel="prev" title="Memory Protection Design" href="memory_domain.html" />
  <meta name="color-scheme" content="dark light">
  
  <link rel="stylesheet" href="../../_static/css/light.css" type="text/css" media="(prefers-color-scheme: light)"/>
  <link rel="stylesheet" href="../../_static/css/dark.css" type="text/css" media="(prefers-color-scheme: dark)"/>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.0-rc3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Document Release Versions</dt>
        
          <dd><a href="/">latest</a></dd>
        
          <dd><a href="/2.7.0/">2.7.0</a></dd>
        
          <dd><a href="/2.6.0/">2.6.0</a></dd>
        
          <dd><a href="/2.5.0/">2.5.0</a></dd>
        
          <dd><a href="/2.4.0/">2.4.0</a></dd>
        
          <dd><a href="/2.3.0/">2.3.0</a></dd>
        
          <dd><a href="/1.14.1/">1.14.1</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
        <dd><a href="/latest/zephyr.pdf">PDF</a></dd>
      </dl>
      <dl>
        <dt>zephyrproject.org Links</dt>
          <dd>
            <a href="https://www.zephyrproject.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/sdk-ng/releases">SDK</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/zephyr/releases">Releases</a>
          </dd>
      </dl>
    </div>
  </div>
  
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/build/index.html">Build and Configuration Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/index.html">Application Development</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Status and Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio/index.html">Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/notify.html">Asynchronous Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/index.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../canbus/index.html">Controller Area Network (CAN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto/index.html">Crypto</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devicetree/index.html">Devicetree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../drivers/index.html">Device Driver Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../display/index.html">Display Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac/index.html">Error Detection And Correction (EDAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file_system/index.html">File Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iterable_sections/index.html">Iterable Sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/formatted_output.html">Formatted Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/index.html">Kernel Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libc/index.html">C standard library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_management/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/index.html">Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_structures/index.html">Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modbus/index.html">Modbus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peripherals/index.html">Peripherals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pinctrl/index.html">Pin Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../random/index.html">Random Number Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resource_management/index.html">Resource Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/index.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../task_wdt/index.html">Task Watchdog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc/timeutil.html">Time Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/index.html">USB device support</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">User Mode</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="memory_domain.html">Memory Protection Design</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Kernel Objects</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#object-placement">Object Placement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dynamic-objects">Dynamic Objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#supervisor-thread-access-permission">Supervisor Thread Access Permission</a></li>
<li class="toctree-l4"><a class="reference internal" href="#user-thread-access-permission">User Thread Access Permission</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initialization-state">Initialization State</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-new-kernel-object-types">Creating New Kernel Object Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api-reference">API Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="syscalls.html">System Calls</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpu_stack_objects.html">MPU Stack Objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpu_userspace.html">MPU Backed Userspace</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../util/index.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../settings/index.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timing_functions/index.html">Executing Time Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../virtualization/index.html">Virtualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/index.html">User and Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Release Notes</a></li>
</ul>

  
  <div class="toctree-wrapper compound">
    <p class="caption"><span class="caption-text">Reference</span></p>
    <ul>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/doxygen/html/index.html">API</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/kconfig/index.html">Kconfig Options</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/devicetree/bindings.html">Devicetree Bindings</a>
      </li>
      
    </ul>
  </div>
  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zephyr Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <!-- Docs / Latest -->
  
  

  <li><a href="../../index.html">Docs / Latest</a> &raquo;</li>
  
     <li><a href="../index.html">API Reference</a> &raquo;</li>
  
     <li><a href="index.html">User Mode</a> &raquo;</li>
  
  <li>Kernel Objects</li>


  <li class="wy-breadcrumbs-aside">
    <dark-mode-toggle id="dark-mode-toggle" appearance="toggle" permanent="true"/>
  </li>
  <li class="wy-breadcrumbs-aside">
      
      
        <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/doc/reference/usermode/kernelobjects.rst" class="fa fa-github"> Open on GitHub</a>
      
    
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
    <div class="wy-alert wy-alert-danger">
     This is the documentation for the latest (main) development branch of
     Zephyr. If you are looking for the documentation of previous releases, use
     the drop-down menu on the left and select the desired version.
    </div>
  
  
           <div itemprop="articleBody">
             
  <div class="section" id="kernel-objects">
<span id="kernelobjects"></span><h1>Kernel Objects<a class="headerlink" href="#kernel-objects" title="Permalink to this headline">¶</a></h1>
<p>A kernel object can be one of three classes of data:</p>
<ul class="simple">
<li><p>A core kernel object, such as a semaphore, thread, pipe, etc.</p></li>
<li><p>A thread stack, which is an array of <code class="xref c c-struct docutils literal notranslate"><span class="pre">z_thread_stack_element</span></code>
and declared with <a class="reference internal" href="../kernel/threads/index.html#c.K_THREAD_STACK_DEFINE" title="K_THREAD_STACK_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_STACK_DEFINE()</span></code></a></p></li>
<li><p>A device driver instance (const struct device) that belongs to one of a defined
set of subsystems</p></li>
</ul>
<p>The set of known kernel objects and driver subsystems is defined in
include/kernel.h as <code class="xref c c-enum docutils literal notranslate"><span class="pre">k_objects</span></code>.</p>
<p>Kernel objects are completely opaque to user threads. User threads work
with addresses to kernel objects when making API calls, but may never
dereference these addresses, doing so will cause a memory protection fault.
All kernel objects must be placed in memory that is not accessible by
user threads.</p>
<p>Since user threads may not directly manipulate kernel objects, all use of
them must go through system calls. In order to perform a system call on
a kernel object, checks are performed by system call handler functions
that the kernel object address is valid and that the calling thread
has sufficient permissions to work with it.</p>
<p>Permission on an object also has the semantics of a reference to an object.
This is significant for certain object APIs which do temporary allocations,
or objects which themselves have been allocated from a runtime memory pool.</p>
<p>If an object loses all references, two events may happen:</p>
<ul class="simple">
<li><p>If the object has an associated cleanup function, the cleanup function
may be called to release any runtime-allocated buffers the object was using.</p></li>
<li><p>If the object itself was dynamically allocated, the memory for the object
will be freed.</p></li>
</ul>
<div class="section" id="object-placement">
<h2>Object Placement<a class="headerlink" href="#object-placement" title="Permalink to this headline">¶</a></h2>
<p>Kernel objects that are only used by supervisor threads have no restrictions
and can be located anywhere in the binary, or even declared on stacks. However,
to prevent accidental or intentional corruption by user threads, they must
not be located in any memory that user threads have direct access to.</p>
<p>In order for a static kernel object to be usable by a user thread via system
call APIs, several conditions must be met on how the kernel object is declared:</p>
<ul class="simple">
<li><p>The object must be declared as a top-level global at build time, such that it
appears in the ELF symbol table. It is permitted to declare kernel objects
with static scope. The post-build script <a class="reference internal" href="../../guides/build/index.html#gen-kobject-list-py"><span class="std std-ref">scripts/gen_kobject_list.py</span></a> scans the
generated ELF file to find kernel objects and places their memory addresses
in a special table of kernel object metadata.  Kernel objects may be members
of arrays or embedded within other data structures.</p></li>
<li><p>Kernel objects must be located in memory reserved for the kernel. They
must not be located in any memory partitions that are user-accessible.</p></li>
<li><p>Any memory reserved for a kernel object must be used exclusively for that
object. Kernel objects may not be members of a union data type.</p></li>
</ul>
<p>Kernel objects that are found but do not meet the above conditions will not be
included in the generated table that is used to validate kernel object pointers
passed in from user mode.</p>
<p>The debug output of the <a class="reference internal" href="../../guides/build/index.html#gen-kobject-list-py"><span class="std std-ref">scripts/gen_kobject_list.py</span></a> script may be useful when
debugging why some object was unexpectedly not being tracked. This
information will be printed if the script is run with the <code class="docutils literal notranslate"><span class="pre">--verbose</span></code> flag,
or if the build system is invoked with verbose output.</p>
</div>
<div class="section" id="dynamic-objects">
<h2>Dynamic Objects<a class="headerlink" href="#dynamic-objects" title="Permalink to this headline">¶</a></h2>
<p>Kernel objects may also be allocated at runtime if
<a class="reference internal" href="../kconfig/dummy-syms.html#std-kconfig-CONFIG_DYNAMIC_OBJECTS"><code class="xref std std-kconfig docutils literal notranslate"><span class="pre">CONFIG_DYNAMIC_OBJECTS</span></code></a> is enabled. In this case, the
<code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_alloc()</span></code> API may be used to instantiate an object from
the calling thread’s resource pool. Such allocations may be freed in two
ways:</p>
<ul class="simple">
<li><p>Supervisor threads may call <a class="reference internal" href="#c.k_object_free" title="k_object_free"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_free()</span></code></a> to force a dynamic
object to be released.</p></li>
<li><p>If an object’s references drop to zero (which happens when no threads have
permissions on it) the object will be automatically freed. User threads
may drop their own permission on an object with
<a class="reference internal" href="#c.k_object_release" title="k_object_release"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_release()</span></code></a>, and their permissions are automatically
cleared when a thread terminates. Supervisor threads may additionally
revoke references for another thread using
<a class="reference internal" href="#c.k_object_access_revoke" title="k_object_access_revoke"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_access_revoke()</span></code></a>.</p></li>
</ul>
<p>Because permissions are also used for reference counting, it is important for
supervisor threads to acquire permissions on objects they are using even though
the access control aspects of the permission system are not enforced.</p>
<div class="section" id="implementation-details">
<h3>Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../../guides/build/index.html#gen-kobject-list-py"><span class="std std-ref">scripts/gen_kobject_list.py</span></a> script is a post-build step which finds all the
valid kernel object instances in the binary. It accomplishes this by parsing
the DWARF debug information present in the generated ELF file for the kernel.</p>
<p>Any instances of structs or arrays corresponding to kernel objects that meet
the object placement criteria will have their memory addresses placed in a
special perfect hash table of kernel objects generated by the ‘gperf’ tool.
When a system call is made and the kernel is presented with a memory address
of what may or may not be a valid kernel object, the address can be validated
with a constant-time lookup in this table.</p>
<p>Drivers are a special case. All drivers are instances of <a class="reference internal" href="../drivers/index.html#c.device" title="device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">device</span></code></a>, but
it is important to know what subsystem a driver belongs to so that
incorrect operations, such as calling a UART API on a sensor driver object, can
be prevented. When a device struct is found, its API pointer is examined to
determine what subsystem the driver belongs to.</p>
<p>The table itself maps kernel object memory addresses to instances of
<code class="xref c c-struct docutils literal notranslate"><span class="pre">z_object</span></code>, which has all the metadata for that object. This
includes:</p>
<ul class="simple">
<li><p>A bitfield indicating permissions on that object. All threads have a
numerical ID assigned to them at build time, used to index the permission
bitfield for an object to see if that thread has permission on it. The size
of this bitfield is controlled by the <a class="reference internal" href="../kconfig/dummy-syms.html#std-kconfig-CONFIG_MAX_THREAD_BYTES"><code class="xref std std-kconfig docutils literal notranslate"><span class="pre">CONFIG_MAX_THREAD_BYTES</span></code></a>
option and the build system will generate an error if this value is too low.</p></li>
<li><p>A type field indicating what kind of object this is, which is some
instance of <code class="xref c c-enum docutils literal notranslate"><span class="pre">k_objects</span></code>.</p></li>
<li><p>A set of flags for that object. This is currently used to track
initialization state and whether an object is public or not.</p></li>
<li><p>An extra data field. The semantics of this field vary by object type, see
the definition of <code class="xref c c-union docutils literal notranslate"><span class="pre">z_object_data</span></code>.</p></li>
</ul>
<p>Dynamic objects allocated at runtime are tracked in a runtime red/black tree
which is used in parallel to the gperf table when validating object pointers.</p>
</div>
</div>
<div class="section" id="supervisor-thread-access-permission">
<h2>Supervisor Thread Access Permission<a class="headerlink" href="#supervisor-thread-access-permission" title="Permalink to this headline">¶</a></h2>
<p>Supervisor threads can access any kernel object. However, permissions for
supervisor threads are still tracked for two reasons:</p>
<ul class="simple">
<li><p>If a supervisor thread calls <a class="reference internal" href="../kernel/threads/index.html#c.k_thread_user_mode_enter" title="k_thread_user_mode_enter"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_thread_user_mode_enter()</span></code></a>, the
thread will then run in user mode with any permissions it had been granted
(in many cases, by itself) when it was a supervisor thread.</p></li>
<li><p>If a supervisor thread creates a user thread with the
<a class="reference internal" href="../kernel/threads/index.html#c.K_INHERIT_PERMS" title="K_INHERIT_PERMS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_INHERIT_PERMS</span></code></a> option, the child thread will be granted the
same permissions as the parent thread, except the parent thread object.</p></li>
</ul>
</div>
<div class="section" id="user-thread-access-permission">
<h2>User Thread Access Permission<a class="headerlink" href="#user-thread-access-permission" title="Permalink to this headline">¶</a></h2>
<p>By default, when a user thread is created, it will only have access permissions
on its own thread object. Other kernel objects by default are not usable.
Access to them needs to be explicitly or implicitly granted. There are several
ways to do this.</p>
<ul class="simple">
<li><p>If a thread is created with the <a class="reference internal" href="../kernel/threads/index.html#c.K_INHERIT_PERMS" title="K_INHERIT_PERMS"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_INHERIT_PERMS</span></code></a>, that thread
will inherit all the permissions of the parent thread, except the parent
thread object.</p></li>
<li><p>A thread that has permission on an object, or is running in supervisor mode,
may grant permission on that object to another thread via the
<a class="reference internal" href="#c.k_object_access_grant" title="k_object_access_grant"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_access_grant()</span></code></a> API. The convenience pseudo-function
<a class="reference internal" href="../kernel/threads/index.html#c.k_thread_access_grant" title="k_thread_access_grant"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_thread_access_grant()</span></code></a> may also be used, which accepts an arbitrary
number of pointers to kernel objects and calls
<a class="reference internal" href="#c.k_object_access_grant" title="k_object_access_grant"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_access_grant()</span></code></a> on each of them. The thread being granted
permission, or the object whose access is being granted, do not need to be
in an initialized state. If the caller is from user mode, the caller must
have permissions on both the kernel object and the target thread object.</p></li>
<li><p>Supervisor threads may declare a particular kernel object to be a public
object, usable by all current and future threads with the
<a class="reference internal" href="#c.k_object_access_all_grant" title="k_object_access_all_grant"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_access_all_grant()</span></code></a> API. You must assume that any
untrusted or exploited code will then be able to access the object. Use
this API with caution!</p></li>
<li><p>If a thread was declared statically with <a class="reference internal" href="../kernel/threads/index.html#c.K_THREAD_DEFINE" title="K_THREAD_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_DEFINE()</span></code></a>,
then the <a class="reference internal" href="#c.K_THREAD_ACCESS_GRANT" title="K_THREAD_ACCESS_GRANT"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_THREAD_ACCESS_GRANT()</span></code></a> may be used to grant that thread
access to a set of kernel objects at boot time.</p></li>
</ul>
<p>Once a thread has been granted access to an object, such access may be
removed with the <a class="reference internal" href="#c.k_object_access_revoke" title="k_object_access_revoke"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_access_revoke()</span></code></a> API. This API is not
available to user threads, however user threads may use
<a class="reference internal" href="#c.k_object_release" title="k_object_release"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_release()</span></code></a> to relinquish their own permissions on an
object.</p>
<p>API calls from supervisor mode to set permissions on kernel objects that are
not being tracked by the kernel will be no-ops. Doing the same from user mode
will result in a fatal error for the calling thread.</p>
<p>Objects allocated with <code class="xref c c-func docutils literal notranslate"><span class="pre">k_object_alloc()</span></code> implicitly grant
permission on the allocated object to the calling thread.</p>
</div>
<div class="section" id="initialization-state">
<h2>Initialization State<a class="headerlink" href="#initialization-state" title="Permalink to this headline">¶</a></h2>
<p>Most operations on kernel objects will fail if the object is considered to be
in an uninitialized state. The appropriate init function for the object must
be performed first.</p>
<p>Some objects will be implicitly initialized at boot:</p>
<ul class="simple">
<li><p>Kernel objects that were declared with static initialization macros
(such as <a class="reference internal" href="../kernel/synchronization/semaphores.html#c.K_SEM_DEFINE" title="K_SEM_DEFINE"><code class="xref c c-macro docutils literal notranslate"><span class="pre">K_SEM_DEFINE</span></code></a> for semaphores) will be in an initialized
state at build time.</p></li>
<li><p>Device driver objects are considered initialized after their init function
is run by the kernel early in the boot process.</p></li>
</ul>
<p>If a kernel object is initialized with a private static initializer, the object
must have <code class="xref c c-func docutils literal notranslate"><span class="pre">z_object_init()</span></code> called on it at some point by a supervisor
thread, otherwise the kernel will consider the object uninitialized if accessed
by a user thread. This is very uncommon, typically only for kernel objects that
are embedded within some larger struct and initialized statically.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_sem</span><span class="w"> </span><span class="n">sem</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">foo</span><span class="w"> </span><span class="n">my_foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">sem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z_SEM_INITIALIZER</span><span class="p">(</span><span class="n">my_foo</span><span class="p">.</span><span class="n">sem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>
<span class="n">z_object_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_foo</span><span class="p">.</span><span class="n">sem</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="creating-new-kernel-object-types">
<h2>Creating New Kernel Object Types<a class="headerlink" href="#creating-new-kernel-object-types" title="Permalink to this headline">¶</a></h2>
<p>When implementing new kernel features or driver subsystems, it may be necessary
to define some new kernel object types. There are different steps needed
for creating core kernel objects and new driver subsystems.</p>
<div class="section" id="creating-new-core-kernel-objects">
<h3>Creating New Core Kernel Objects<a class="headerlink" href="#creating-new-core-kernel-objects" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">scripts/gen_kobject_list.py</span></code>, add the name of the struct to the
<code class="xref py py-data docutils literal notranslate"><span class="pre">kobjects</span></code> list.</p></li>
</ul>
<p>Instances of the new struct should now be tracked.</p>
</div>
<div class="section" id="creating-new-driver-subsystem-kernel-objects">
<h3>Creating New Driver Subsystem Kernel Objects<a class="headerlink" href="#creating-new-driver-subsystem-kernel-objects" title="Permalink to this headline">¶</a></h3>
<p>All driver instances are <a class="reference internal" href="../drivers/index.html#c.device" title="device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">device</span></code></a>. They are differentiated by
what API struct they are set to.</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">scripts/gen_kobject_list.py</span></code>, add the name of the API struct for the
new subsystem to the <code class="xref py py-data docutils literal notranslate"><span class="pre">subsystems</span></code> list.</p></li>
</ul>
<p>Driver instances of the new subsystem should now be tracked.</p>
</div>
</div>
<div class="section" id="configuration-options">
<h2>Configuration Options<a class="headerlink" href="#configuration-options" title="Permalink to this headline">¶</a></h2>
<p>Related configuration options:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../kconfig/dummy-syms.html#std-kconfig-CONFIG_USERSPACE"><code class="xref std std-kconfig docutils literal notranslate"><span class="pre">CONFIG_USERSPACE</span></code></a></p></li>
<li><p><a class="reference internal" href="../kconfig/dummy-syms.html#std-kconfig-CONFIG_MAX_THREAD_BYTES"><code class="xref std std-kconfig docutils literal notranslate"><span class="pre">CONFIG_MAX_THREAD_BYTES</span></code></a></p></li>
</ul>
</div>
<div class="section" id="api-reference">
<h2>API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h2>
<dl>
<dt class="sig sig-object cpp">
<span class="target" id="group__usermode__apis"></span><em><span class="pre">group</span></em> <span class="sig-name descname"><span class="pre">usermode_apis</span></span></dt>
<dd><div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-defines">Defines</p>
<dl class="c macro">
<dt class="sig sig-object c" id="c.K_THREAD_ACCESS_GRANT">
<span class="target" id="group__usermode__apis_1ga6a2dae4c6dc6959d8785ff1924b1b424"></span><span class="sig-name descname"><span class="n"><span class="pre">K_THREAD_ACCESS_GRANT</span></span></span><span class="sig-paren">(</span><span class="n"><span class="pre">name_</span></span>, <span class="p"><span class="pre">...</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.K_THREAD_ACCESS_GRANT" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Grant a static thread access to a list of kernel objects. </p>
<p>For threads declared with <a class="reference internal" href="../kernel/threads/index.html#group__thread__apis_1gab3ced58648ca35788a40676e8478ecd2"><span class="std std-ref">K_THREAD_DEFINE()</span></a>, grant the thread access to a set of kernel objects. These objects do not need to be in an initialized state. The permissions will be granted when the threads are initialized in the early boot sequence.</p>
<p>All arguments beyond the first must be pointers to kernel objects.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name_</strong> – Name of the thread, as passed to <a class="reference internal" href="../kernel/threads/index.html#group__thread__apis_1gab3ced58648ca35788a40676e8478ecd2"><span class="std std-ref">K_THREAD_DEFINE()</span></a> </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.K_OBJ_FLAG_INITIALIZED">
<span class="target" id="group__usermode__apis_1ga1418482d67c7964855570fd0ac79628d"></span><span class="sig-name descname"><span class="n"><span class="pre">K_OBJ_FLAG_INITIALIZED</span></span></span><a class="headerlink" href="#c.K_OBJ_FLAG_INITIALIZED" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Object initialized </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.K_OBJ_FLAG_PUBLIC">
<span class="target" id="group__usermode__apis_1ga8892f9343266ec24abf25e29f3f6bc9b"></span><span class="sig-name descname"><span class="n"><span class="pre">K_OBJ_FLAG_PUBLIC</span></span></span><a class="headerlink" href="#c.K_OBJ_FLAG_PUBLIC" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Object is Public </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.K_OBJ_FLAG_ALLOC">
<span class="target" id="group__usermode__apis_1ga1bf7c8c1d5fe0a7358dd70c4663a5a7a"></span><span class="sig-name descname"><span class="n"><span class="pre">K_OBJ_FLAG_ALLOC</span></span></span><a class="headerlink" href="#c.K_OBJ_FLAG_ALLOC" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Object allocated </p>
</dd></dl>

<dl class="c macro">
<dt class="sig sig-object c" id="c.K_OBJ_FLAG_DRIVER">
<span class="target" id="group__usermode__apis_1ga82d3a7242074db70130415201d3d0fd6"></span><span class="sig-name descname"><span class="n"><span class="pre">K_OBJ_FLAG_DRIVER</span></span></span><a class="headerlink" href="#c.K_OBJ_FLAG_DRIVER" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Driver Object </p>
</dd></dl>

</div>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-functions">Functions</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.k_object_access_grant">
<span class="target" id="group__usermode__apis_1ga94087bedf96fe2a2bea437d3d585ca22"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">k_object_access_grant</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">object</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../kernel/threads/index.html#c.k_thread" title="k_thread"><span class="n"><span class="pre">k_thread</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">thread</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.k_object_access_grant" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Grant a thread access to a kernel object</p>
<p>The thread will be granted access to the object if the caller is from supervisor mode, or the caller is from user mode AND has permissions on both the object and the thread whose access is being granted.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>object</strong> – Address of kernel object </p></li>
<li><p><strong>thread</strong> – Thread to grant access to the object </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.k_object_access_revoke">
<span class="target" id="group__usermode__apis_1gab70fe65497da1347cc4b7bf7ca2daf22"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">k_object_access_revoke</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">object</span></span>, <span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="../kernel/threads/index.html#c.k_thread" title="k_thread"><span class="n"><span class="pre">k_thread</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">thread</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.k_object_access_revoke" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Revoke a thread’s access to a kernel object</p>
<p>The thread will lose access to the object if the caller is from supervisor mode, or the caller is from user mode AND has permissions on both the object and the thread whose access is being revoked.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>object</strong> – Address of kernel object </p></li>
<li><p><strong>thread</strong> – Thread to remove access to the object </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.k_object_release">
<span class="target" id="group__usermode__apis_1ga3cb1a024c0178918def2dd0186e565b3"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">k_object_release</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">object</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.k_object_release" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Release an object. </p>
<p>Allows user threads to drop their own permission on an object Their permissions are automatically cleared when a thread terminates.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>object</strong> – The object to be released </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.k_object_access_all_grant">
<span class="target" id="group__usermode__apis_1gababc731e98a6378323c0d633b2abaa6a"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">k_object_access_all_grant</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">object</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.k_object_access_all_grant" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Grant all present and future threads access to an object</p>
<p>If the caller is from supervisor mode, or the caller is from user mode and have sufficient permissions on the object, then that object will have permissions granted to it for <em>all</em> current and future threads running in the system, effectively becoming a public kernel object.</p>
<p>Use of this API should be avoided on systems that are running untrusted code as it is possible for such code to derive the addresses of kernel objects and perform unwanted operations on them.</p>
<p>It is not possible to revoke permissions on public objects; once public, any thread may use it.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>object</strong> – Address of kernel object </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.k_object_free">
<span class="target" id="group__usermode__apis_1gaf66c8cbe6e0a387551c5bebb6634bde2"></span><span class="k"><span class="pre">static</span></span><span class="w"> </span><span class="k"><span class="pre">inline</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">k_object_free</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">obj</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.k_object_free" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Free an object. </p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>obj</strong> – </p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
</dd></dl>

</div>
</div>


           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2015-2021 Zephyr Project members and individual contributors.
      <span class="lastupdated">Last updated on Feb 21, 2022.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>