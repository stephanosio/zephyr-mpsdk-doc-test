<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Time Utilities &mdash; Zephyr Project Documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script type="module" src="../../_static/js/dark-mode-toggle.min.mjs"></script>
        <script src="https://www.googletagmanager.com/gtag/js?id=UA-831873-47"></script>
        <script src="../../_static/js/ga-tracker.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="USB device support" href="../usb/index.html" />
    <link rel="prev" title="Task Watchdog" href="../task_wdt/index.html" />
  <meta name="color-scheme" content="dark light">
  
  <link rel="stylesheet" href="../../_static/css/light.css" type="text/css" media="(prefers-color-scheme: light)"/>
  <link rel="stylesheet" href="../../_static/css/dark.css" type="text/css" media="(prefers-color-scheme: dark)"/>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.99
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Zephyr Project</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Document Release Versions</dt>
        
          <dd><a href="/">latest</a></dd>
        
          <dd><a href="/3.0.0/">3.0.0</a></dd>
        
          <dd><a href="/2.7.0/">2.7.0</a></dd>
        
          <dd><a href="/2.6.0/">2.6.0</a></dd>
        
          <dd><a href="/2.5.0/">2.5.0</a></dd>
        
          <dd><a href="/2.4.0/">2.4.0</a></dd>
        
          <dd><a href="/2.3.0/">2.3.0</a></dd>
        
          <dd><a href="/1.14.1/">1.14.1</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
        <dd><a href="/latest/zephyr.pdf">PDF</a></dd>
      </dl>
      <dl>
        <dt>zephyrproject.org Links</dt>
          <dd>
            <a href="https://www.zephyrproject.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/sdk-ng/releases">SDK</a>
          </dd>
          <dd>
            <a href="https://github.com/zephyrproject-rtos/zephyr/releases">Releases</a>
          </dd>
      </dl>
    </div>
  </div>
  
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development_process/index.html">Development and Contribution Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/build/index.html">Build and Configuration Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/index.html">Application Development</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">API Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Status and Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../audio/index.html">Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="notify.html">Asynchronous Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/index.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../canbus/index.html">Controller Area Network (CAN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto/index.html">Crypto</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devicetree/index.html">Devicetree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../drivers/index.html">Device Driver Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../display/index.html">Display Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac/index.html">Error Detection And Correction (EDAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file_system/index.html">File Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iterable_sections/index.html">Iterable Sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="formatted_output.html">Formatted Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel/index.html">Kernel Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libc/index.html">C standard library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_management/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html">Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_structures/index.html">Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modbus/index.html">Modbus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peripherals/index.html">Peripherals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pinctrl/index.html">Pin Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../random/index.html">Random Number Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../resource_management/index.html">Resource Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell/index.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../task_wdt/index.html">Task Watchdog</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Time Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time-utility-apis">Time Utility APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#representation-transformation">Representation Transformation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#time-scale-synchronization">Time Scale Synchronization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#concepts-underlying-time-support-in-zephyr">Concepts Underlying Time Support in Zephyr</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#relevant-time-scales">Relevant Time Scales</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../usb/index.html">USB device support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usermode/index.html">User Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../util/index.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../settings/index.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timing_functions/index.html">Executing Time Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../virtualization/index.html">Virtualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/index.html">User and Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/index.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Release Notes</a></li>
</ul>

  
  <div class="toctree-wrapper compound">
    <p class="caption"><span class="caption-text">Reference</span></p>
    <ul>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/doxygen/html/index.html">API</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/kconfig.html">Kconfig Options</a>
      </li>
      
      <li class="toctree-l1">
        <a class="reference internal" href="/latest/reference/devicetree/bindings.html">Devicetree Bindings</a>
      </li>
      
    </ul>
  </div>
  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Zephyr Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
  <!-- Docs / Latest -->
  
  

  <li><a href="../../index.html">Docs / Latest</a> &raquo;</li>
  
     <li><a href="../index.html">API Reference</a> &raquo;</li>
  
  <li>Time Utilities</li>


  <li class="wy-breadcrumbs-aside">
    <dark-mode-toggle id="dark-mode-toggle" appearance="toggle" permanent="true"/>
  </li>
  <li class="wy-breadcrumbs-aside">
      
      
        <a href="https://github.com/zephyrproject-rtos/zephyr/blob/main/doc/reference/misc/timeutil.rst" class="fa fa-github"> Open on GitHub</a>
      
    
  </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  
    <div class="wy-alert wy-alert-danger">
     This is the documentation for the latest (main) development branch of
     Zephyr. If you are looking for the documentation of previous releases, use
     the drop-down menu on the left and select the desired version.
    </div>
  
  
           <div itemprop="articleBody">
             
  <div class="section" id="time-utilities">
<span id="timeutil-api"></span><h1>Time Utilities<a class="headerlink" href="#time-utilities" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../kernel/timing/clocks.html#kernel-timing-uptime"><span class="std std-ref">Uptime</span></a> in Zephyr is based on the a tick counter.  With
the default <a class="reference internal" href="../../kconfig.html#CONFIG_TICKLESS_KERNEL" title="CONFIG_TICKLESS_KERNEL"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_TICKLESS_KERNEL</span></code></a> this counter advances at a
nominally constant rate from zero at the instant the system started. The POSIX
equivalent to this counter is something like <code class="docutils literal notranslate"><span class="pre">CLOCK_MONOTONIC</span></code> or, in Linux,
<code class="docutils literal notranslate"><span class="pre">CLOCK_MONOTONIC_RAW</span></code>.  <a class="reference internal" href="../kernel/timing/clocks.html#c.k_uptime_get" title="k_uptime_get"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_uptime_get()</span></code></a> provides a millisecond
representation of this time.</p>
<p>Applications often need to correlate the Zephyr internal time with external
time scales used in daily life, such as local time or Coordinated Universal
Time.  These systems interpret time in different ways and may have
discontinuities due to <a class="reference external" href="https://what-if.xkcd.com/26/">leap seconds</a> and
local time offsets like daylight saving time.</p>
<p>Because of these discontinuities, as well as significant inaccuracies in the
clocks underlying the cycle counter, the offset between time estimated from
the Zephyr clock and the actual time in a “real” civil time scale is not
constant and can vary widely over the runtime of a Zephyr application.</p>
<p>The time utilities API supports:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#timeutil-repr"><span class="std std-ref">converting between time representations</span></a></p></li>
<li><p><a class="reference internal" href="#timeutil-sync"><span class="std std-ref">synchronizing and aligning time scales</span></a></p></li>
</ul>
<p>For terminology and concepts that support these functions see
<a class="reference internal" href="#timeutil-concepts"><span class="std std-ref">Concepts Underlying Time Support in Zephyr</span></a>.</p>
</div>
<div class="section" id="time-utility-apis">
<h2>Time Utility APIs<a class="headerlink" href="#time-utility-apis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="representation-transformation">
<span id="timeutil-repr"></span><h3>Representation Transformation<a class="headerlink" href="#representation-transformation" title="Permalink to this headline">¶</a></h3>
<p>Time scale instants can be represented in multiple ways including:</p>
<ul class="simple">
<li><p>Seconds since an epoch. POSIX representations of time in this form include
<code class="docutils literal notranslate"><span class="pre">time_t</span></code> and <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">timespec</span></code>, which are generally interpreted as a
representation of <a class="reference external" href="https://tools.ietf.org/html/rfc8536#section-2">“UNIX Time”</a>.</p></li>
<li><p>Calendar time as a year, month, day, hour, minutes, and seconds relative to
an epoch. POSIX representations of time in this form include <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">tm</span></code>.</p></li>
</ul>
<p>Keep in mind that these are simply time representations that must be
interpreted relative to a time scale which may be local time, UTC, or some
other continuous or discontinuous scale.</p>
<p>Some necessary transformations are available in standard C library
routines. For example, <code class="docutils literal notranslate"><span class="pre">time_t</span></code> measuring seconds since the POSIX EPOCH is
converted to <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">tm</span></code> representing calendar time with <a class="reference external" href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/gmtime.html">gmtime()</a>.
Sub-second timestamps like <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">timespec</span></code> can also use this to produce
the calendar time representation and deal with sub-second offsets separately.</p>
<p>The inverse transformation is not standardized: APIs like <code class="docutils literal notranslate"><span class="pre">mktime()</span></code> expect
information about time zones.  Zephyr provides this transformation with
<a class="reference internal" href="#c.timeutil_timegm" title="timeutil_timegm"><code class="xref c c-func docutils literal notranslate"><span class="pre">timeutil_timegm()</span></code></a> and <a class="reference internal" href="#c.timeutil_timegm64" title="timeutil_timegm64"><code class="xref c c-func docutils literal notranslate"><span class="pre">timeutil_timegm64()</span></code></a>.</p>
<dl>
<dt class="sig sig-object cpp">
<span class="target" id="group__timeutil__repr__apis"></span><em><span class="pre">group</span></em> <span class="sig-name descname"><span class="pre">timeutil_repr_apis</span></span></dt>
<dd><div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-functions">Functions</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_timegm64">
<span class="target" id="group__timeutil__repr__apis_1gac4d2957df896a77eb317e10318adf481"></span><span class="n"><span class="pre">int64_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_timegm64</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_timegm64" title="tm"><span class="n"><span class="pre">tm</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">tm</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_timegm64" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Convert broken-down time to a POSIX epoch offset in seconds. </p>
<p><div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="http://man7.org/linux/man-pages/man3/timegm.3.html">http://man7.org/linux/man-pages/man3/timegm.3.html</a> </p>
</div>
</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tm</strong> – pointer to broken down time.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the corresponding time in the POSIX epoch time scale.</p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_timegm">
<span class="target" id="group__timeutil__repr__apis_1ga959ea90efd605477ddc7eee3ed72a643"></span><span class="n"><span class="pre">time_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_timegm</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_timegm" title="tm"><span class="n"><span class="pre">tm</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">tm</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_timegm" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Convert broken-down time to a POSIX epoch offset in seconds. </p>
<p><div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="http://man7.org/linux/man-pages/man3/timegm.3.html">http://man7.org/linux/man-pages/man3/timegm.3.html</a> </p>
</div>
</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tm</strong> – pointer to broken down time.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the corresponding time in the POSIX epoch time scale. If the time cannot be represented then <code class="docutils literal notranslate"></code>(time_t)-1 is returned and <code class="docutils literal notranslate"><span class="pre">errno</span></code> is set to <code class="docutils literal notranslate"><span class="pre">ERANGE`</span></code>.</p>
</dd>
</dl>
</dd></dl>

</div>
</dd></dl>

</div>
<div class="section" id="time-scale-synchronization">
<span id="timeutil-sync"></span><h3>Time Scale Synchronization<a class="headerlink" href="#time-scale-synchronization" title="Permalink to this headline">¶</a></h3>
<p>There are several factors that affect synchronizing time scales:</p>
<ul class="simple">
<li><p>The rate of discrete instant representation change.  For example Zephyr
uptime is tracked in ticks which advance at events that nominally occur at
<a class="reference internal" href="../../kconfig.html#CONFIG_SYS_CLOCK_TICKS_PER_SEC" title="CONFIG_SYS_CLOCK_TICKS_PER_SEC"><code class="xref kconfig kconfig-option docutils literal notranslate"><span class="pre">CONFIG_SYS_CLOCK_TICKS_PER_SEC</span></code></a> Hertz, while an external time
source may provide data in whole or fractional seconds (e.g. microseconds).</p></li>
<li><p>The absolute offset required to align the two scales at a single instant.</p></li>
<li><p>The relative error between observable instants in each scale, required to
align multiple instants consistently.  For example a reference clock that’s
conditioned by a 1-pulse-per-second GPS signal will be much more accurate
than a Zephyr system clock driven by a RC oscillator with a +/- 250 ppm
error.</p></li>
</ul>
<p>Synchronization or alignment between time scales is done with a multi-step
process:</p>
<ul class="simple">
<li><p>An instant in a time scale is represented by an (unsigned) 64-bit integer,
assumed to advance at a fixed nominal rate.</p></li>
<li><p><a class="reference internal" href="#c.timeutil_sync_config" title="timeutil_sync_config"><code class="xref c c-struct docutils literal notranslate"><span class="pre">timeutil_sync_config</span></code></a> records the nominal rates of a reference
time scale/source (e.g. TAI) and a local time source
(e.g. <a class="reference internal" href="../kernel/timing/clocks.html#c.k_uptime_ticks" title="k_uptime_ticks"><code class="xref c c-func docutils literal notranslate"><span class="pre">k_uptime_ticks()</span></code></a>).</p></li>
<li><p><a class="reference internal" href="#c.timeutil_sync_instant" title="timeutil_sync_instant"><code class="xref c c-struct docutils literal notranslate"><span class="pre">timeutil_sync_instant</span></code></a> records the representation of a single
instant in both the reference and local time scales.</p></li>
<li><p><a class="reference internal" href="#c.timeutil_sync_state" title="timeutil_sync_state"><code class="xref c c-struct docutils literal notranslate"><span class="pre">timeutil_sync_state</span></code></a> provides storage for an initial instant, a
recently received second observation, and a skew that can adjust for
relative errors in the actual rate of each time scale.</p></li>
<li><p><a class="reference internal" href="#c.timeutil_sync_ref_from_local" title="timeutil_sync_ref_from_local"><code class="xref c c-func docutils literal notranslate"><span class="pre">timeutil_sync_ref_from_local()</span></code></a> and
<a class="reference internal" href="#c.timeutil_sync_local_from_ref" title="timeutil_sync_local_from_ref"><code class="xref c c-func docutils literal notranslate"><span class="pre">timeutil_sync_local_from_ref()</span></code></a> convert instants in one time scale
to another taking into account skew that can be estimated from the two
instances stored in the state structure by
<a class="reference internal" href="#c.timeutil_sync_estimate_skew" title="timeutil_sync_estimate_skew"><code class="xref c c-func docutils literal notranslate"><span class="pre">timeutil_sync_estimate_skew()</span></code></a>.</p></li>
</ul>
<dl>
<dt class="sig sig-object cpp">
<span class="target" id="group__timeutil__sync__apis"></span><em><span class="pre">group</span></em> <span class="sig-name descname"><span class="pre">timeutil_sync_apis</span></span></dt>
<dd><div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-functions">Functions</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_sync_state_update">
<span class="target" id="group__timeutil__sync__apis_1gaa6926a23d1c4fbb61584e957d157bd62"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_state_update</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_state" title="timeutil_sync_state"><span class="n"><span class="pre">timeutil_sync_state</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">tsp</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_instant" title="timeutil_sync_instant"><span class="n"><span class="pre">timeutil_sync_instant</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">inst</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_sync_state_update" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Record a new instant in the time synchronization state. </p>
<p>Note that this updates only the latest persisted instant. The skew is not adjusted automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tsp</strong> – pointer to a <a class="reference internal" href="#structtimeutil__sync__state"><span class="std std-ref">timeutil_sync_state</span></a> object.</p></li>
<li><p><strong>inst</strong> – the new instant to be recorded. This becomes the base instant if there is no base instant, otherwise the value must be strictly after the base instant in both the reference and local time scales.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>0</strong> – if installation succeeded in providing a new base </p></li>
<li><p><strong>1</strong> – if installation provided a new latest instant </p></li>
<li><p><strong>-EINVAL</strong> – if the new instant is not compatible with the base instant </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_sync_state_set_skew">
<span class="target" id="group__timeutil__sync__apis_1ga01142931b299e848b0642634a0922be5"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_state_set_skew</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_state" title="timeutil_sync_state"><span class="n"><span class="pre">timeutil_sync_state</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">tsp</span></span>, <span class="kt"><span class="pre">float</span></span><span class="w"> </span><span class="n"><span class="pre">skew</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_instant" title="timeutil_sync_instant"><span class="n"><span class="pre">timeutil_sync_instant</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">base</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_sync_state_set_skew" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Update the state with a new skew and possibly base value. </p>
<p>Set the skew from a value retrieved from persistent storage, or calculated based on recent skew estimations including from <a class="reference internal" href="#group__timeutil__sync__apis_1gac4c25a1ed054a8a06c87d4df9c25ffc6"><span class="std std-ref">timeutil_sync_estimate_skew()</span></a>.</p>
<p>Optionally update the base timestamp. If the base is replaced the latest instant will be cleared until <a class="reference internal" href="#group__timeutil__sync__apis_1gaa6926a23d1c4fbb61584e957d157bd62"><span class="std std-ref">timeutil_sync_state_update()</span></a> is invoked.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tsp</strong> – pointer to a time synchronization state.</p></li>
<li><p><strong>skew</strong> – the skew to be used. The value must be positive and shouldn’t be too far away from 1.</p></li>
<li><p><strong>base</strong> – optional new base to be set. If provided this becomes the base timestamp that will be used along with skew to convert between reference and local timescale instants. Setting the base clears the captured latest value.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>0 if skew was updated </p>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>-EINVAL if skew was not valid </p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_sync_estimate_skew">
<span class="target" id="group__timeutil__sync__apis_1gac4c25a1ed054a8a06c87d4df9c25ffc6"></span><span class="kt"><span class="pre">float</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_estimate_skew</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_state" title="timeutil_sync_state"><span class="n"><span class="pre">timeutil_sync_state</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">tsp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_sync_estimate_skew" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Estimate the skew based on current state. </p>
<p>Using the base and latest syncpoints from the state determine the skew of the local clock relative to the reference clock. See <a class="reference internal" href="#structtimeutil__sync__state_1a39454807d207dddb2564d766c8ec2ea3"><span class="std std-ref">timeutil_sync_state::skew</span></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tsp</strong> – pointer to a time synchronization state. The base and latest syncpoints must be present and the latest syncpoint must be after the base point in the local time scale.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the estimated skew, or zero if skew could not be estimated. </p>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_sync_ref_from_local">
<span class="target" id="group__timeutil__sync__apis_1ga75361d2bfd219f1e8107d635eb4ecc16"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_ref_from_local</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_state" title="timeutil_sync_state"><span class="n"><span class="pre">timeutil_sync_state</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">tsp</span></span>, <span class="n"><span class="pre">uint64_t</span></span><span class="w"> </span><span class="n"><span class="pre">local</span></span>, <span class="n"><span class="pre">uint64_t</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">refp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_sync_ref_from_local" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Interpolate a reference timescale instant from a local instant. </p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tsp</strong> – pointer to a time synchronization state. This must have a base and a skew installed.</p></li>
<li><p><strong>local</strong> – an instant measured in the local timescale. This may be before or after the base instant.</p></li>
<li><p><strong>refp</strong> – where the corresponding instant in the reference timescale should be stored. A negative interpolated reference time produces an error. If interpolation fails the referenced object is not modified.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>0</strong> – if interpolated using a skew of 1 </p></li>
<li><p><strong>1</strong> – if interpolated using a skew not equal to 1 </p></li>
<li><p><strong>-EINVAL</strong> – <ul>
<li><p>the times synchronization state is not adequately initialized</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refp</span></code> is null </p></li>
</ul>
</p></li>
<li><p><strong>-ERANGE</strong> – the interpolated reference time would be negative </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_sync_local_from_ref">
<span class="target" id="group__timeutil__sync__apis_1gad8ef92e5dc72bd26d765567134044400"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_local_from_ref</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_state" title="timeutil_sync_state"><span class="n"><span class="pre">timeutil_sync_state</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">tsp</span></span>, <span class="n"><span class="pre">uint64_t</span></span><span class="w"> </span><span class="n"><span class="pre">ref</span></span>, <span class="n"><span class="pre">int64_t</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">localp</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_sync_local_from_ref" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Interpolate a local timescale instant from a reference instant. </p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tsp</strong> – pointer to a time synchronization state. This must have a base and a skew installed.</p></li>
<li><p><strong>ref</strong> – an instant measured in the reference timescale. This may be before or after the base instant.</p></li>
<li><p><strong>localp</strong> – where the corresponding instant in the local timescale should be stored. An interpolated value before local time 0 is provided without error. If interpolation fails the referenced object is not modified.</p></li>
</ul>
</dd>
<dt class="field-even">Return values</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>0</strong> – if successful with a skew of 1 </p></li>
<li><p><strong>1</strong> – if successful with a skew not equal to 1 </p></li>
<li><p><strong>-EINVAL</strong> – <ul>
<li><p>the time synchronization state is not adequately initialized</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refp</span></code> is null </p></li>
</ul>
</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="c function">
<dt class="sig sig-object c" id="c.timeutil_sync_skew_to_ppb">
<span class="target" id="group__timeutil__sync__apis_1gabe374cf629ee64b850cc49e954666d8d"></span><span class="n"><span class="pre">int32_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_skew_to_ppb</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">float</span></span><span class="w"> </span><span class="n"><span class="pre">skew</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.timeutil_sync_skew_to_ppb" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Convert from a skew to an error in parts-per-billion. </p>
<p>A skew of 1.0 has zero error. A skew less than 1 has a positive error (clock is faster than it should be). A skew greater than one has a negative error (clock is slower than it should be).</p>
<p>Note that due to the limited precision of <code class="docutils literal notranslate"><span class="pre">float</span></code> compared with <code class="docutils literal notranslate"><span class="pre">double</span></code> the smallest error that can be represented is about 120 ppb. A “precise” time source may have error on the order of 2000 ppb.</p>
<p>A skew greater than 3.14748 may underflow the 32-bit representation; this represents a clock running at less than 1/3 its nominal rate.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>skew error represented as parts-per-billion, or INT32_MIN if the skew cannot be represented in the return type. </p>
</dd>
</dl>
</dd></dl>

</div>
<dl class="c struct">
<dt class="sig sig-object c" id="c.timeutil_sync_config">
<span class="target" id="structtimeutil__sync__config"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_config</span></span></span><a class="headerlink" href="#c.timeutil_sync_config" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;timeutil.h&gt;</em></div>
<p>Immutable state for synchronizing two clocks. </p>
<p>Values required to convert durations between two time scales.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The accuracy of the translation and calculated skew between sources depends on the resolution of these frequencies. A reference frequency with microsecond or nanosecond resolution would produce the most accurate tracking when the local reference is the Zephyr tick counter. A reference source like an RTC chip with 1 Hz resolution requires a much larger interval between sampled instants to detect relative clock drift. </p>
</div>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-public-members">Public Members</p>
<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_config.ref_Hz">
<span class="target" id="structtimeutil__sync__config_1a0ee43492ae85a6305a326046501a8ac7"></span><span class="n"><span class="pre">uint32_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">ref_Hz</span></span></span><a class="headerlink" href="#c.timeutil_sync_config.ref_Hz" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The nominal instance counter rate in Hz.</p>
<p>This value is assumed to be precise, but may drift depending on the reference clock source.</p>
<p>The value must be positive. </p>
</dd></dl>

<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_config.local_Hz">
<span class="target" id="structtimeutil__sync__config_1a4c180ceb790108292c8c7a825792603f"></span><span class="n"><span class="pre">uint32_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">local_Hz</span></span></span><a class="headerlink" href="#c.timeutil_sync_config.local_Hz" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The nominal local counter rate in Hz.</p>
<p>This value is assumed to be inaccurate but reasonably stable. For a local clock driven by a crystal oscillator an error of 25 ppm is common; for an RC oscillator larger errors should be expected. The timeutil_sync infrastructure can calculate the skew between the local and reference clocks and apply it when converting between time scales.</p>
<p>The value must be positive. </p>
</dd></dl>

</div>
</dd></dl>

<dl class="c struct">
<dt class="sig sig-object c" id="c.timeutil_sync_instant">
<span class="target" id="structtimeutil__sync__instant"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_instant</span></span></span><a class="headerlink" href="#c.timeutil_sync_instant" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;timeutil.h&gt;</em></div>
<p>Representation of an instant in two time scales. </p>
<p>Capturing the same instant in two time scales provides a registration point that can be used to convert between those time scales. </p>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-public-members">Public Members</p>
<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_instant.ref">
<span class="target" id="structtimeutil__sync__instant_1a192ad09026e7b511d0961218e34ea201"></span><span class="n"><span class="pre">uint64_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">ref</span></span></span><a class="headerlink" href="#c.timeutil_sync_instant.ref" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>An instant in the reference time scale.</p>
<p>This must never be zero in an initialized <a class="reference internal" href="#structtimeutil__sync__instant"><span class="std std-ref">timeutil_sync_instant</span></a> object. </p>
</dd></dl>

<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_instant.local">
<span class="target" id="structtimeutil__sync__instant_1a7ebc45287a8ae8d546dc249499f91337"></span><span class="n"><span class="pre">uint64_t</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">local</span></span></span><a class="headerlink" href="#c.timeutil_sync_instant.local" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The corresponding instance in the local time scale.</p>
<p>This may be zero in a valid <a class="reference internal" href="#structtimeutil__sync__instant"><span class="std std-ref">timeutil_sync_instant</span></a> object. </p>
</dd></dl>

</div>
</dd></dl>

<dl class="c struct">
<dt class="sig sig-object c" id="c.timeutil_sync_state">
<span class="target" id="structtimeutil__sync__state"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">timeutil_sync_state</span></span></span><a class="headerlink" href="#c.timeutil_sync_state" title="Permalink to this definition">¶</a><br /></dt>
<dd><div class="docutils container">
<em>#include &lt;timeutil.h&gt;</em></div>
<p>State required to convert instants between time scales. </p>
<p>This state in conjunction with functions that manipulate it capture the offset information necessary to convert between two timescales along with information that corrects for skew due to inaccuracies in clock rates.</p>
<p>State objects should be zero-initialized before use. </p>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric" id="breathe-section-title-public-members">Public Members</p>
<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_state.cfg">
<span class="target" id="structtimeutil__sync__state_1a2a22936f3ba24fcfb7704e2157ae3e96"></span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_config" title="timeutil_sync_config"><span class="n"><span class="pre">timeutil_sync_config</span></span></a><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">cfg</span></span></span><a class="headerlink" href="#c.timeutil_sync_state.cfg" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Pointer to reference and local rate information. </p>
</dd></dl>

<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_state.base">
<span class="target" id="structtimeutil__sync__state_1aadbd2ecd98197865e3a71daa8967ce99"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_instant" title="timeutil_sync_instant"><span class="n"><span class="pre">timeutil_sync_instant</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">base</span></span></span><a class="headerlink" href="#c.timeutil_sync_state.base" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The base instant in both time scales. </p>
</dd></dl>

<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_state.latest">
<span class="target" id="structtimeutil__sync__state_1a49dc5405c4818a339a68ad6ef33aa4e8"></span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><a class="reference internal" href="#c.timeutil_sync_instant" title="timeutil_sync_instant"><span class="n"><span class="pre">timeutil_sync_instant</span></span></a><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">latest</span></span></span><a class="headerlink" href="#c.timeutil_sync_state.latest" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The most recent instant in both time scales.</p>
<p>This is captured here to provide data for skew calculation. </p>
</dd></dl>

<dl class="c var">
<dt class="sig sig-object c" id="c.timeutil_sync_state.skew">
<span class="target" id="structtimeutil__sync__state_1a39454807d207dddb2564d766c8ec2ea3"></span><span class="kt"><span class="pre">float</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">skew</span></span></span><a class="headerlink" href="#c.timeutil_sync_state.skew" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The scale factor used to correct for clock skew.</p>
<p>The nominal rate for the local counter is assumed to be inaccurate but stable, i.e. it will generally be some parts-per-million faster or slower than specified.</p>
<p>A duration in observed local clock ticks must be multiplied by this value to produce a duration in ticks of a clock operating at the nominal local rate.</p>
<p>A zero value indicates that the skew has not been initialized. If the value is zero when <a class="reference internal" href="#structtimeutil__sync__state_1aadbd2ecd98197865e3a71daa8967ce99"><span class="std std-ref">base</span></a> is initialized the skew will be set to 1. Otherwise the skew is assigned through <a class="reference internal" href="#group__timeutil__sync__apis_1ga01142931b299e848b0642634a0922be5"><span class="std std-ref">timeutil_sync_state_set_skew()</span></a>. </p>
</dd></dl>

</div>
</dd></dl>

</dd></dl>

</div>
</div>
<div class="section" id="concepts-underlying-time-support-in-zephyr">
<span id="timeutil-concepts"></span><h2>Concepts Underlying Time Support in Zephyr<a class="headerlink" href="#concepts-underlying-time-support-in-zephyr" title="Permalink to this headline">¶</a></h2>
<p>Terms from <a class="reference external" href="https://www.loc.gov/standards/datetime/iso-tc154-wg5_n0038_iso_wd_8601-1_2016-02-16.pdf">ISO/TC 154/WG 5 N0038</a>
(ISO/WD 8601-1) and elsewhere:</p>
<ul class="simple">
<li><p>A <em>time axis</em> is a representation of time as an ordered sequence of
instants.</p></li>
<li><p>A <em>time scale</em> is a way of representing an instant relative to an origin
that serves as the epoch.</p></li>
<li><p>A time scale is <em>monotonic</em> (increasing) if the representation of successive
time instants never decreases in value.</p></li>
<li><p>A time scale is <em>continuous</em> if the representation has no abrupt changes in
value, e.g. jumping forward or back when going between successive instants.</p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Civil_time">Civil time</a> generally refers
to time scales that legally defined by civil authorities, like local
governments, often to align local midnight to solar time.</p></li>
</ul>
<div class="section" id="relevant-time-scales">
<h3>Relevant Time Scales<a class="headerlink" href="#relevant-time-scales" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/International_Atomic_Time">International Atomic Time</a> (TAI) is a time
scale based on averaging clocks that count in SI seconds. TAI is a montonic
and continuous time scale.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Universal_Time">Universal Time</a> (UT) is a
time scale based on Earth’s rotation. UT is a discontinuous time scale as it
requires occasional adjustments (<a class="reference external" href="https://en.wikipedia.org/wiki/Leap_second">leap seconds</a>) to maintain alignment to
changes in Earth’s rotation. Thus the difference between TAI and UT varies
over time. There are several variants of UT, with <a class="reference external" href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a> being the most
common.</p>
<p>UT times are independent of location. UT is the basis for Standard Time
(or “local time”) which is the time at a particular location. Standard
time has a fixed offset from UT at any given instant, primarily
influenced by longitude, but the offset may be adjusted (“daylight
saving time”) to align standard time to the local solar time. In a sense
local time is “more discontinuous” than UT.</p>
<p><a class="reference external" href="https://tools.ietf.org/html/rfc8536#section-2">POSIX Time</a> is a time scale
that counts seconds since the “POSIX epoch” at 1970-01-01T00:00:00Z (i.e. the
start of 1970 UTC). <a class="reference external" href="https://tools.ietf.org/html/rfc8536#section-2">UNIX Time</a> is an extension of POSIX
time using negative values to represent times before the POSIX epoch. Both of
these scales assume that every day has exactly 86400 seconds. In normal use
instants in these scales correspond to times in the UTC scale, so they inherit
the discontinuity.</p>
<p>The continuous analogue is <a class="reference external" href="https://tools.ietf.org/html/rfc8536#section-2">UNIX Leap Time</a> which is UNIX time plus all
leap-second corrections added after the POSIX epoch (when TAI-UTC was 8 s).</p>
<div class="section" id="example-of-time-scale-differences">
<h4>Example of Time Scale Differences<a class="headerlink" href="#example-of-time-scale-differences" title="Permalink to this headline">¶</a></h4>
<p>A positive leap second was introduced at the end of 2016, increasing the
difference between TAI and UTC from 36 seconds to 37 seconds. There was
no leap second introduced at the end of 1999, when the difference
between TAI and UTC was only 32 seconds. The following table shows
relevant civil and epoch times in several scales:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 14%" />
<col style="width: 27%" />
<col style="width: 10%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>UTC Date</p></th>
<th class="head"><p>UNIX time</p></th>
<th class="head"><p>TAI Date</p></th>
<th class="head"><p>TAI-UTC</p></th>
<th class="head"><p>UNIX Leap Time</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1970-01-01T00:00:00Z</p></td>
<td><p>0</p></td>
<td><p>1970-01-01T00:00:08</p></td>
<td><p>+8</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>1999-12-31T23:59:28Z</p></td>
<td><p>946684768</p></td>
<td><p>2000-01-01T00:00:00</p></td>
<td><p>+32</p></td>
<td><p>946684792</p></td>
</tr>
<tr class="row-even"><td><p>1999-12-31T23:59:59Z</p></td>
<td><p>946684799</p></td>
<td><p>2000-01-01T00:00:31</p></td>
<td><p>+32</p></td>
<td><p>946684823</p></td>
</tr>
<tr class="row-odd"><td><p>2000-01-01T00:00:00Z</p></td>
<td><p>946684800</p></td>
<td><p>2000-01-01T00:00:32</p></td>
<td><p>+32</p></td>
<td><p>946684824</p></td>
</tr>
<tr class="row-even"><td><p>2016-12-31T23:59:59Z</p></td>
<td><p>1483228799</p></td>
<td><p>2017-01-01T00:00:35</p></td>
<td><p>+36</p></td>
<td><p>1483228827</p></td>
</tr>
<tr class="row-odd"><td><p>2016-12-31T23:59:60Z</p></td>
<td><p>undefined</p></td>
<td><p>2017-01-01T00:00:36</p></td>
<td><p>+36</p></td>
<td><p>1483228828</p></td>
</tr>
<tr class="row-even"><td><p>2017-01-01T00:00:00Z</p></td>
<td><p>1483228800</p></td>
<td><p>2017-01-01T00:00:37</p></td>
<td><p>+37</p></td>
<td><p>1483228829</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="functional-requirements">
<h4>Functional Requirements<a class="headerlink" href="#functional-requirements" title="Permalink to this headline">¶</a></h4>
<p>The Zephyr tick counter has no concept of leap seconds or standard time
offsets and is a continuous time scale. However it can be relatively
inaccurate, with drifts as much as three minutes per hour (assuming an RC
timer with 5% tolerance).</p>
<p>There are two stages required to support conversion between Zephyr time and
common human time scales:</p>
<ul class="simple">
<li><p>Translation between the continuous but inaccurate Zephyr time scale and an
accurate external stable time scale;</p></li>
<li><p>Translation between the stable time scale and the (possibly discontinuous)
civil time scale.</p></li>
</ul>
<p>The API around <a class="reference internal" href="#c.timeutil_sync_state_update" title="timeutil_sync_state_update"><code class="xref c c-func docutils literal notranslate"><span class="pre">timeutil_sync_state_update()</span></code></a> supports the first step
of converting between continuous time scales.</p>
<p>The second step requires external information including schedules of leap
seconds and local time offset changes. This may be best provided by an
external library, and is not currently part of the time utility APIs.</p>
</div>
<div class="section" id="selecting-an-external-source-and-time-scale">
<h4>Selecting an External Source and Time Scale<a class="headerlink" href="#selecting-an-external-source-and-time-scale" title="Permalink to this headline">¶</a></h4>
<p>If an application requires civil time accuracy within several seconds then UTC
could be used as the stable time source. However, if the external source
adjusts to a leap second there will be a discontinuity: the elapsed time
between two observations taken at 1 Hz is not equal to the numeric difference
between their timestamps.</p>
<p>For precise activities a continuous scale that is independent of local and
solar adjustments simplifies things considerably. Suitable continuous scales
include:</p>
<ul class="simple">
<li><p>GPS time: epoch of 1980-01-06T00:00:00Z, continuous following TAI with an
offset of TAI-GPS=19 s.</p></li>
<li><p>Bluetooth mesh time: epoch of 2000-01-01T00:00:00Z, continuous following TAI
with an offset of -32.</p></li>
<li><p>UNIX Leap Time: epoch of 1970-01-01T00:00:00Z, continuous following TAI with
an offset of -8.</p></li>
</ul>
<p>Because C and Zephyr library functions support conversion between integral and
calendar time representations using the UNIX epoch, UNIX Leap Time is an ideal
choice for the external time scale.</p>
<p>The mechanism used to populate synchronization points is not relevant: it may
involve reading from a local high-precision RTC peripheral, exchanging packets
over a network using a protocol like NTP or PTP, or processing NMEA messages
received a GPS with or without a 1pps signal.</p>
</div>
</div>
</div>
</div>


           </div>
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html">Copyright</a> 2015-2022 Zephyr Project members and individual contributors.
      <span class="lastupdated">Last updated on Mar 05, 2022.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>